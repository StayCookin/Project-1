<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile - InRent</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./css/main.css" />
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-1F24YHYS28"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-1F24YHYS28");
    </script>
    <style>
      body {
        background: #f8fafb;
        font-family: "Poppins", "Inter", Arial, sans-serif;
      }
      .profile-header {
        width: 100%;
        background: var(--forest-green, #228b22);
        color: #fff;
        padding: 1.2rem 0;
        text-align: left;
        font-size: 2rem;
        font-weight: 700;
        letter-spacing: 1px;
        box-shadow: 0 2px 8px rgba(34, 139, 34, 0.08);
        margin-bottom: 1.5rem;
        position: relative;
      }
      .dashboard-description {
        max-width: 700px;
        margin: 0 auto 1.2rem auto;
        padding: 0 1.5rem 0.5rem 1.5rem;
        color: #444;
        font-size: 1.08rem;
        line-height: 1.6;
      }
      .profile-image-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 2rem;
        position: relative;
      }
      .profile-image {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #228b22;
        background: #e6e6e6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }
      .image-upload-overlay {
        position: absolute;
        bottom: 10px;
        right: calc(50% - 60px);
        background: #fff;
        border: 1.5px solid #228b22;
        border-radius: 50%;
        padding: 0.5rem;
        cursor: pointer;
        color: #228b22;
        font-size: 1.2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: background 0.2s;
      }
      .image-upload-overlay:hover {
        background: #f0f0f0;
      }
      .upload-progress {
        width: 120px;
        height: 8px;
        background: #e6e6e6;
        border-radius: 4px;
        margin: 0 auto 1rem auto;
        overflow: hidden;
        display: none;
      }
      .upload-progress-bar {
        height: 100%;
        background: #228b22;
        width: 0%;
        transition: width 0.3s;
      }
      .image-preview {
        display: none;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        margin: 1rem auto 0 auto;
        border: 2px solid #228b22;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        overflow: auto;
        background: rgba(0, 0, 0, 0.25);
        align-items: center;
        justify-content: center;
      }
      .modal.show {
        display: flex;
      }
      .modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 2rem 2.5rem;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.13);
        position: relative;
        width: 100%;
        max-width: 550px;
      }
      .modal-close {
        position: absolute;
        top: 1rem;
        right: 1.2rem;
        font-size: 1.5rem;
        color: #888;
        cursor: pointer;
      }
      .form-group {
        margin-bottom: 1.2rem;
      }
      .form-group label {
        font-weight: 500;
        color: #228b22;
        margin-bottom: 0.4rem;
        display: block;
      }
      .form-group textarea {
        width: 100%;
        border: 1px solid #228b22;
        border-radius: 6px;
        padding: 0.7rem 1rem;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
      }
      .btn {
        background: #228b22;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 0.6rem 1.2rem;
        font-weight: 600;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.2s;
      }
      .btn:hover {
        background: #176b16;
      }
      .success-message {
        color: #228b22;
        font-weight: 500;
        margin-top: 0.7rem;
        font-size: 1rem;
      }
      .rating-stars {
        display: flex;
        gap: 0.3rem;
        font-size: 1.5rem;
        color: #ffd700;
      }
      .logout-btn {
        background: #fff;
        color: #228b22;
        border: 1.5px solid #228b22;
        font-size: 1rem;
        font-weight: 600;
        padding: 0.5rem 1.2rem;
        border-radius: 5px;
        transition: background 0.2s, color 0.2s;
        box-shadow: 0 2px 8px rgba(34, 139, 34, 0.13);
        position: absolute;
        top: 18px;
        right: 24px;
        z-index: 10;
      }
      .logout-btn:hover {
        background: #228b22;
        color: #fff;
      }
      @media (max-width: 900px) {
        .marketplace-header {
          font-size: 2rem;
        }
        .logout-btn {
          top: 12px;
          right: 12px;
          font-size: 0.95rem;
          padding: 0.45rem 1rem;
        }
        .profile-image {
          width: 120px !important;
          height: 120px !important;
        }
      }
      @media (max-width: 600px) {
        .marketplace-header {
          font-size: 1.3rem;
          padding: 0.8rem 0;
        }
        .logout-btn {
          top: 8px;
          right: 8px;
          font-size: 0.9rem;
          padding: 0.4rem 0.8rem;
        }
        .profile-image {
          width: 90px !important;
          height: 90px !important;
        }
        .profile-image-container {
          left: 0 !important;
          top: 1.2rem !important;
          position: static !important;
          margin: 0 auto 1.2rem auto !important;
        }
        .upload-photo-btn {
          font-size: 0.95rem !important;
          padding: 0.4rem 1rem !important;
          bottom: 8px !important;
        }
        .dashboard-description {
          font-size: 0.98rem;
          padding: 0 0.5rem 0.5rem 0.5rem;
        }
        .modal-content {
          padding: 1.2rem 0.7rem;
        }
      }
      @media (max-width: 400px) {
        .logout-btn {
          font-size: 0.8rem;
          padding: 0.3rem 0.6rem;
        }
        .profile-image {
          width: 70px !important;
          height: 70px !important;
        }
      }
      .marketplace-header {
        position: relative;
        margin-bottom: 2.5rem;
        text-align: center;
        font-size: 2.6rem;
        font-weight: 800;
        color: #222;
        letter-spacing: 1.5px;
      }
      .marketplace-header .in {
        color: #228b22;
        font-size: 2.8rem;
      }
      .marketplace-header .rent {
        color: #176b16;
        font-size: 2.8rem;
      }
      .profile-image-container {
        margin-bottom: 2.2rem;
      }
      .profile-image {
        width: 180px !important;
        height: 180px !important;
        border-radius: 22px !important;
        object-fit: cover;
        border: 3px solid #228b22;
        background: #e6e6e6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: block;
      }
      .upload-photo-btn {
        position: absolute;
        bottom: 18px;
        left: 50%;
        transform: translateX(-50%);
        background: #228b22;
        color: #fff;
        border-radius: 22px;
        padding: 0.6rem 1.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(34, 139, 34, 0.13);
        border: none;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .upload-photo-btn:hover {
        background: #176b16 !important;
      }
    </style>
  </head>
  <body>
    <div class="marketplace-header" style="position: relative">
      <span class="in">In</span><span class="rent">Rent</span>
      <div
        style="
          font-size: 2.1rem;
          color: #111;
          font-weight: 700;
          margin-top: 0.2rem;
        "
      >
        Profile
      </div>
      <button
        id="logoutBtn"
        class="btn logout-btn"
        style="
          position: absolute;
          top: 18px;
          right: 24px;
          background: #fff;
          color: #228b22;
          border: 1.5px solid #228b22;
          font-size: 1rem;
          font-weight: 600;
          padding: 0.5rem 1.2rem;
          border-radius: 5px;
          z-index: 10;
        "
      >
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
    <div class="dashboard-description">
      Welcome to your student dashboard. Here you can manage your profile, view
      and manage your saved property bookings, and communicate directly with
      landlords. Use the options below to keep track of your housing journey and
      connect with property owners easily.
    </div>
    <div
      class="profile-image-container"
      style="position: absolute; top: 2.5rem; left: 2.5rem; margin-bottom: 0"
    >
      <div style="position: relative">
        <img
          src="/img/default-profile.png"
          alt="Profile"
          class="profile-image"
          id="profileImage"
          style="
            width: 180px;
            height: 180px;
            border-radius: 22px;
            object-fit: cover;
            border: 3px solid #228b22;
            background: #e6e6e6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: block;
          "
        />
        <label
          for="imageUpload"
          class="upload-photo-btn"
          style="
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            background: #228b22;
            color: #fff;
            border-radius: 22px;
            padding: 0.6rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(34, 139, 34, 0.13);
            border: none;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
          "
        >
          <i class="fas fa-upload"></i> Upload Photo
        </label>
        <input
          type="file"
          id="imageUpload"
          accept="image/*"
          style="display: none"
        />
      </div>
    </div>
    <div class="upload-progress" id="uploadProgress">
      <div class="upload-progress-bar" id="uploadProgressBar"></div>
    </div>
    <img id="imagePreview" class="image-preview" />

    <!-- Saved Bookings Section -->
    <section
      class="saved-bookings-section"
      style="
        max-width: 700px;
        margin: 0 auto 2rem auto;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        padding: 2rem 1.5rem;
      "
    >
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.2rem;
        "
      >
        <h2
          style="font-size: 1.3rem; color: #228b22; font-weight: 600; margin: 0"
        >
          Saved Bookings
        </h2>
        <button
          class="btn"
          id="messagesBtn"
          style="
            background: #fff;
            color: #228b22;
            border: 1.5px solid #228b22;
            font-size: 1rem;
            font-weight: 600;
            padding: 0.5rem 1.2rem;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 0.4rem;
          "
        >
          <i class="fas fa-comments"></i> Messages
        </button>
      </div>
      <div id="savedBookingsList">
        <!-- Bookings will be rendered here -->
      </div>
    </section>
    <!-- Review Modal -->
    <div class="modal" id="review-modal">
      <div class="modal-content" style="max-width: 550px">
        <span class="modal-close">Ã—</span>
        <h3 id="reviewModalTitle">Write a Review</h3>
        <form id="reviewForm">
          <div class="form-group">
            <label>Your Rating:</label>
            <div class="rating-stars" id="reviewRatingStars"></div>
          </div>
          <div class="form-group">
            <label for="reviewText">Your Review:</label>
            <textarea id="reviewText" required rows="4"></textarea>
          </div>
          <button type="submit" class="btn">Submit Review</button>
          <div class="success-message" id="reviewFormSuccess"></div>
        </form>
      </div>
    </div>
    <script src="./js/user-profile.js" defer></script>
    <script src="/js/index.js" defer></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const messagesBtnHeader = document.getElementById("messagesBtnHeader");
        if (messagesBtnHeader) {
          messagesBtnHeader.addEventListener("click", function () {
            window.location.href = "messages.html";
          });
        }
      });
      // Messages button navigation
      document.addEventListener("DOMContentLoaded", function () {
        const messagesBtn = document.getElementById("messagesBtn");
        if (messagesBtn) {
          messagesBtn.addEventListener("click", function () {
            window.location.href = "messages.html";
          });
        }
      });
      // Logout button functionality
      document.addEventListener("DOMContentLoaded", function () {
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async function () {
            // Clear local/session storage
            localStorage.clear();
            sessionStorage.clear();
            // Call backend logout endpoint if available
            try {
              await fetch("/api/logout", {
                method: "POST",
                credentials: "include",
              });
            } catch (e) {}
            // Redirect to homepage
            window.location.href = "../index.html";
          });
        }
      });
      // --- Saved Bookings Logic ---
      // Dummy fetch function, replace with AJAX to backend
      async function fetchSavedBookings() {
        try {
          const res = await fetch("/api/saved-properties", {
            credentials: "include",
          });
          if (!res.ok) throw new Error("Failed to fetch saved properties");
          const data = await res.json();
          // Map backend data to expected format
          return data.map((item) => ({
            id: item._id,
            property: item.property.title,
            location: item.property.location,
            date: item.property.dateAvailable || "",
            acquired: false, // You can update this if you store acquired status
            landlordId: item.property.landlord || "",
            propertyId: item.property._id,
          }));
        } catch (err) {
          return [];
        }
      }
      function renderSavedBookings() {
        const bookings = fetchSavedBookings(); // Replace with AJAX
        const list = document.getElementById("savedBookingsList");
        if (!bookings.length) {
          list.innerHTML =
            '<div style="color:#888;text-align:center;">No saved bookings yet.</div>';
          return;
        }
        list.innerHTML = bookings
          .map(
            (b) => `
        <div class="booking-card" style="display:flex;align-items:center;justify-content:space-between;padding:1rem 0;border-bottom:1px solid #eee;gap:1rem;">
          <div style="flex:1;">
            <div style="font-weight:600;font-size:1.1rem;color:#222;">${
              b.property
            }</div>
            <div style="color:#228b22;font-size:0.98rem;">${b.location}</div>
            <div style="color:#666;font-size:0.95rem;">Viewing: ${b.date}</div>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center;">
            <button class="btn" style="background:#fff;color:#b00;border:1.5px solid #b00;padding:0.4rem 1rem;" onclick="deleteBooking('${
              b.id
            }')"><i class='fas fa-trash'></i> Delete</button>
            ${
              {
                true: `<button class='btn' style='background:#228b22;color:#fff;cursor:default;' disabled>Acquired</button>`,
                false: `<button class='btn' style='background:#228b22;color:#fff;' onclick=\"markAcquired('${b.id}')\">Mark as Acquired</button>`,
              }[b.acquired]
            }
            <button class="btn" style="background:#fff;color:#228b22;border:1.5px solid #228b22;padding:0.4rem 1rem;" onclick="openMessage('${
              b.landlordId
            }','${b.propertyId}','${
              b.property
            }')"><i class='fas fa-comments'></i> Message</button>
            <button class="btn" style="background:#fff;color:#176b16;border:1.5px solid #176b16;padding:0.4rem 1rem;" onclick="viewPropertyDetails('${
              b.propertyId
            }')"><i class='fas fa-eye'></i> View Details</button>
          </div>
        </div>
      `
          )
          .join("");
      }
      function deleteBooking(id) {
        // AJAX call to delete booking
        fetch(`/api/saved-properties/${id}`, {
          method: "DELETE",
          credentials: "include",
        })
          .then(() => renderSavedBookings())
          .catch(() => renderSavedBookings());
      }
      function markAcquired(id) {
        // TODO: AJAX call to mark as acquired
        alert("Booking marked as acquired: " + id);
        // Update UI (for demo)
        renderSavedBookings();
      }
      function openMessage(landlordId, propertyId, propertyName) {
        // Store context in sessionStorage/localStorage for messages page
        sessionStorage.setItem("messageLandlordId", landlordId);
        sessionStorage.setItem("messagePropertyId", propertyId);
        sessionStorage.setItem("messagePropertyName", propertyName);
        window.location.href = "messages.html";
      }
      function viewPropertyDetails(propertyId) {
        window.location.href = `property-details.html?id=${propertyId}`;
      }
      document.addEventListener("DOMContentLoaded", renderSavedBookings);
    </script>
  </body>
</html>
