<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - InRent</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
      .google_sign_in {
        background: #fff;
        color: var(--forest-green);
        border: 1px solid #ddd;
        border-radius: 15px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background 0.3s;
      }
      .google_sign_in:hover {
        background: #f9f9f9;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.01);
      }
      .google_sign_in::before {
        content: "";
        background: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJNMTcuNiA5LjJsLS4xLTEuOEg5djMuNGg0LjhDMTMuNiAxMiAxMyAxMyAxMiAxMy42djIuMmgzYTguOCA4LjggMCAwIDAgMi42LTYuNnoiIGZpbGw9IiM0Mjg1RjQiIGZpbGwtcnVsZT0ibm9uemVybyIvPjxwYXRoIGQ9Ik05IDE4YzIuNCAwIDQuNS0uOCA2LTIuMmwtMy0yLjJhNS40IDUuNCAwIDAgMS04LTIuOUgxVjEzYTkgOSAwIDAgMCA4IDV6IiBmaWxsPSIjMzRBODUzIiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNNCAxMC43YTUuNCA1LjQgMCAwIDEgMC0zLjRWNUgxYTkgOSAwIDAgMCAwIDhsMy0yLjN6IiBmaWxsPSIjRkJCQzA1IiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNOSAzLjZjMS4zIDAgMi41LjQgMy40IDEuM0wxNSAyLjNBOSA5IDAgMCAwIDEgNWwzIDIuNGE1LjQgNS40IDAgMCAxIDUtMy43eiIgZmlsbD0iI0VBNDMzNSIgZmlsbC1ydWxlPSJub256ZXJvIi8+PHBhdGggZD0iTTAgMGgxOHYxOEgweiIvPjwvZz48L3N2Zz4=");
        display: block;
        width: 18px;
        height: 18px;
      }
      :root {
        --forest-green: #228b22;
        --black: #000000;
        --white: #ffffff;
      }
      body {
        background-image: url("log.jpg");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
      }
      .bg-forest {
        background-color: var(--forest-green);
      }
      .text-forest {
        color: var(--forest-green);
      }
      .border-forest {
        border-color: var(--forest-green);
      }
      .centered-form-container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .centered-form-container form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background: rgba(250,250,250, 0.9);
        padding: 2.5rem 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        min-width: 320px;
        max-width: 400px;
        width: 100%;
      }
      .centered-form-container label {
        text-align: left;
        margin-bottom: 0.3rem;
        font-weight: 500;
      }
      .centered-form-container input[type="email"],
      .centered-form-container input[type="password"] {
        padding: 0.7rem;
        border: 1px solid #228b22;
        border-radius: 5px;
        font-size: 1rem;
        width: 100%;
        box-sizing: border-box;
      }
      .centered-form-container .btn {
        margin-top: 1rem;
        background: var(--forest-green);
        color: #fff;
        font-weight: 600;
        border: none;
        border-radius: 5px;
        padding: 0.7rem;
        cursor: pointer;
        transition: background 0.2s;
      }
      .centered-form-container .btn:hover {
        background: #000;
      }
      .centered-form-container a.btn-link {
        color: var(--forest-green);
        text-decoration: underline;
        background: none;
        border: none;
        padding: 0;
        font-weight: 500;
        cursor: pointer;
      }
      @media (max-width: 600px) {
        .centered-form-container form {
          min-width: 100vw;
          max-width: 100vw;
          padding: 1.2rem 0.5rem;
          border-radius: 0;
          box-shadow: none;
        }
        .centered-form-container {
          padding: 0;
        }
        label,
        input,
        button {
          font-size: 1.1rem;
        }
      }
      input:focus,
      button:focus {
        outline: 2px solid #228b22;
        outline-offset: 2px;
      }
    </style>
  </head>
  <body
    class="min-h-screen flex flex-col items-center justify-center relative overflow-x-hidden"
  >
    <!-- Floating 'In' pattern background -->
    
    <div class="w-full flex justify-center py-4 z-10 relative">
      <span class="text-3xl font-bold text-forest"
        >In<span class="text-black">Rent</span></span
      >
    </div>
    <div class="centered-form-container z-10 relative">
      <h2
        style="
          text-align: center;
          color: var(--forest-green);
          font-size: 2rem;
          font-weight: 600;
          margin-bottom: 1.5rem;
        "
      >
        Log In
      </h2>
      <form id="loginForm" autocomplete="off">
        <label for="email">Email Address:</label>
        <input
          type="email"
          id="email"
          name="email"
          required
          autocomplete="email"
        />
        <label for="password">Password:</label>
        <input
          type="password"
          id="password"
          name="password"
          required
          autocomplete="current-password"
        />
        <button class="btn btn-secondary" type="submit" aria-label="Log In">
          Log In
        </button>
        <div
          class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full text-center"
        >
          <p class="text-gray-600 mb-8">Sign in with Google.</p>
          <button id="googleBtn" class="google_sign_in">Sign In</button>
        </div>

        <div style="text-align: center; margin-top: 1rem">
          Don't have an account?
          <a href="signup.html" class="btn-link" aria-label="Sign Up"
            >Sign Up</a
          >
        </div>
        <div
          id="loginError"
          style="color: red; text-align: center; margin-top: 1rem"
          aria-live="polite"
        ></div>
      </form>
    </div>
  </body>
</form>
    </div>
  </body>
  
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script type="module" defer>

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { 
  getAuth,
  signInWithEmailAndPassword, 
  signInWithPopup, 
  GoogleAuthProvider,
  onAuthStateChanged,
  signOut,
  sendPasswordResetEmail,
  sendEmailVerification
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCZuEC4QU-RYxQbjWqBoxk6j1mbwwRtRBo",
  authDomain: "inrent-6ab14.firebaseapp.com",
  databaseURL: "https://inrent-6ab14-default-rtdb.firebaseio.com",
  projectId: "inrent-6ab14",
  storageBucket: "inrent-6ab14.firebasestorage.app",
  messagingSenderId: "327416190792",
  appId: "1:327416190792:web:970377ec8dcef557e5457d",
  measurementId: "G-JY9E760ZQ0"
};
// Initialize Firebase
let app, auth, db;
try {
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
  console.log("✅ Firebase initialized successfully for login");
} catch (err) {
  console.error("❌ Firebase initialization failed:", err);
  alert("Failed to initialize Firebase. Please refresh the page and try again.");
}

// Utility functions
function showMessage(element, message, type = 'error', duration = 5000) {
  if (!element) return;
  
  const colors = {
    error: '#dc3545',
    success: '#28a745',
    warning: '#ffc107',
    info: '#17a2b8'
  };
  
  element.style.color = colors[type] || colors.error;
  element.textContent = message;
  element.style.display = 'block';
  
  // Auto-hide success and info messages
  if (type === 'success' || type === 'info') {
    setTimeout(() => {
      element.style.display = 'none';
    }, duration);
  }
}

function setButtonLoading(button, isLoading, loadingText = 'Loading...', originalText = 'Submit') {
  if (!button) return;
  
  if (isLoading) {
    button.disabled = true;
    button.innerHTML = `
      <span class="spinner" style="margin-right:8px;width:16px;height:16px;border:2px solid #fff;border-top:2px solid transparent;border-radius:50%;display:inline-block;vertical-align:middle;animation:spin 1s linear infinite;"></span>
      ${loadingText}
    `;
  } else {
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

// Enhanced check authentication function
function checkAuth() {
  return new Promise((resolve) => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      unsubscribe(); // Unsubscribe after first call
      resolve(user);
    });
  });
}

// Validate user profile and role
async function validateUserProfile(user) {
  try {
    const userDocRef = doc(db, "users", user.uid);
    const userDoc = await getDoc(userDocRef);

    const userData = userDoc.data();
    const requiredFields = ['email', 'role', 'createdAt'];
    const missingFields = requiredFields.filter(field => !userData.hasOwnProperty(field));
    
    if (missingFields.length > 0) {
      throw new Error(`INCOMPLETE_PROFILE: ${missingFields.join(', ')}`);
    }

    // Validate role
    const role = userData.role.toLowerCase();
    const validRoles = ['student', 'landlord'];
    if (!validRoles.includes(role)) {
      throw new Error(`INVALID_ROLE: ${userData.role}`);
    }

    return { valid: true, userData };
  } catch (error) {
    return { 
      valid: false, 
      error: error.message,
      userData: null 
    };
  }
}


async function handleGoogleUserCreation(user) {
  try {
    // Create basic profile for Google users
    await setDoc(doc(db, "users", user.uid), {
      email: user.email,
      role: 'landlord', // Default role, user can change later
      displayName: user.displayName || '',
      photoURL: user.photoURL || '',
      provider: 'google',
      emailVerified: user.emailVerified,
      createdAt: new Date(),
      updatedAt: new Date(),
      requiresProfileCompletion: true // Flag to show profile completion modal
    });
    
    return true;
  } catch (error) {
    console.error("Failed to create Google user profile:", error);
    return false;
  }
}

document.addEventListener("DOMContentLoaded", function () {
  const loginForm = document.getElementById("loginForm");
  const errorDiv = document.getElementById("loginError");
  const submitBtn = loginForm?.querySelector('button[type="submit"]');
  const googleBtn = document.getElementById("googleBtn");
  const forgotPasswordLink = document.getElementById("forgotPasswordLink");

  // Check if user is already logged in
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      console.log("🔍 User already authenticated, validating profile...");
      
      if (!user.emailVerified) {
        console.log("⚠️ Email not verified for existing user");
        showMessage(errorDiv, "Please verify your email address first.", 'warning');
        return;
      }

      const validation = await validateUserProfile(user);
      if (validation.valid) {
        console.log("✅ User profile valid, redirecting to marketplace");
        showMessage(errorDiv, "Welcome back! Redirecting...", 'success');
        setTimeout(() => {
          window.location.href = "marketplace.html";
        }, 1000);
      } else {
        console.log("❌ Profile validation failed:", validation.error);
        if (validation.error.includes('PROFILE_NOT_FOUND')) {
          showMessage(errorDiv, "Profile not found. Please sign up first.", 'error');
        }
      }
    }
  });

  // Email/Password Login
  if (loginForm && submitBtn) {
    loginForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      
      const email = document.getElementById("email")?.value?.trim();
      const password = document.getElementById("password")?.value;
      const originalButtonText = submitBtn.textContent;

      // Clear previous messages
      if (errorDiv) errorDiv.style.display = 'none';

      // Validation
      if (!email || !password) {
        showMessage(errorDiv, "Please fill in all fields.", 'error');
        return;
      }

      if (!email.includes('@')) {
        showMessage(errorDiv, "Please enter a valid email address.", 'error');
        return;
      }

      if (password.length < 6) {
        showMessage(errorDiv, "Password must be at least 6 characters long.", 'error');
        return;
      }

      setButtonLoading(submitBtn, true, 'Logging In...', originalButtonText);

      try {
        console.log("🔐 Attempting login for:", email);
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        console.log("✅ Authentication successful for user:", user.uid);

        // Check email verification
        if (!user.emailVerified) {
          console.log("📧 Email not verified");
          showMessage(errorDiv, "Please verify your email before logging in.", 'warning');
          
          // Offer to resend verification email
          const resendBtn = document.createElement('button');
          resendBtn.textContent = 'Resend Verification Email';
          resendBtn.style.marginLeft = '10px';
          resendBtn.style.padding = '5px 10px';
          resendBtn.style.fontSize = '12px';
          
          resendBtn.onclick = async () => {
            try {
              await sendEmailVerification(user);
              showMessage(errorDiv, "Verification email sent! Check your inbox.", 'success');
              resendBtn.remove();
            } catch (error) {
              console.error("Failed to resend verification:", error);
              showMessage(errorDiv, "Failed to send verification email. Try again later.", 'error');
            }
          };
          
          errorDiv.appendChild(resendBtn);
          await signOut(auth); // Sign out unverified user
          return;
        }

        // Validate user profile
        const validation = await validateUserProfile(user);
        if (!validation.valid) {
          console.error("❌ Profile validation failed:", validation.error);
          
          if (validation.error.includes('PROFILE_NOT_FOUND')) {
            showMessage(errorDiv, "User profile not found. Please contact support or sign up again.", 'error');
          } else if (validation.error.includes('INCOMPLETE_PROFILE')) {
            showMessage(errorDiv, "Your profile is incomplete. Please contact support.", 'error');
          } else if (validation.error.includes('INVALID_ROLE')) {
            showMessage(errorDiv, "Invalid user role. Please contact support.", 'error');
          } else {
            showMessage(errorDiv, "Profile validation failed. Please contact support.", 'error');
          }
          
          await signOut(auth);
          return;
        }

        // Success
        console.log("🎉 Login successful, profile validated");
        showMessage(errorDiv, "Login successful! Redirecting...", 'success');
        
        setTimeout(() => {
          window.location.href = "marketplace.html";
        }, 1000);

      } catch (error) {
        console.error("❌ Login failed:", error);
        
        // Enhanced error handling
        let errorMessage = "Login failed. Please try again.";
        
        switch (error.code) {
          case "auth/user-not-found":
            errorMessage = "No account found with this email address.";
            break;
          case "auth/wrong-password":
          case "auth/invalid-credential":
            errorMessage = "Incorrect password. Please try again.";
            break;
          case "auth/too-many-requests":
            errorMessage = "Too many failed attempts. Please wait a few minutes before trying again.";
            break;
          case "auth/user-disabled":
            errorMessage = "This account has been disabled. Please contact support.";
            break;
          case "auth/invalid-email":
            errorMessage = "Invalid email address format.";
            break;
          case "auth/network-request-failed":
            errorMessage = "Network error. Please check your internet connection.";
            break;
          default:
            errorMessage = error.message || errorMessage;
        }
        
        showMessage(errorDiv, errorMessage, 'error');
      } finally {
        setButtonLoading(submitBtn, false, '', originalButtonText);
      }
    });
  }

  // Google Sign-In with enhanced handling
  if (googleBtn) {
    googleBtn.addEventListener("click", async function () {
      const provider = new GoogleAuthProvider();
      provider.addScope('email');
      provider.addScope('profile');
      
      // Clear previous messages
      if (errorDiv) errorDiv.style.display = 'none';
      
      setButtonLoading(googleBtn, true, 'Signing in with Google...', 'Continue with Google');
      
      try {
        console.log("🔐 Attempting Google sign-in");
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        
        console.log("✅ Google authentication successful for user:", user.uid);
        
        // Check if user profile exists
        const validation = await validateUserProfile(user);
        
        if (!validation.valid && validation.error.includes('PROFILE_NOT_FOUND')) {
          console.log("📝 Creating profile for new Google user");
          const profileCreated = await handleGoogleUserCreation(user);
          
          if (!profileCreated) {
            showMessage(errorDiv, "Failed to create user profile. Please try again.", 'error');
            await signOut(auth);
            return;
          }
          
          showMessage(errorDiv, "Welcome! Please complete your profile setup.", 'success');
          // Redirect to profile completion or marketplace with a flag
          setTimeout(() => {
            window.location.href = "marketplace.html?complete-profile=true";
          }, 1500);
          
        } else if (validation.valid) {
          console.log("✅ Google login successful, existing profile found");
          showMessage(errorDiv, "Welcome back! Redirecting...", 'success');
          setTimeout(() => {
            window.location.href = "marketplace.html";
          }, 1000);
          
        } else {
          console.error("❌ Profile validation failed for Google user:", validation.error);
          showMessage(errorDiv, "Profile validation failed. Please contact support.", 'error');
          await signOut(auth);
        }
        
      } catch (error) {
        console.error("❌ Google sign-in failed:", error);
        
        let errorMessage = "Google sign-in failed. Please try again.";
        
        switch (error.code) {
          case "auth/popup-closed-by-user":
            errorMessage = "Sign-in was cancelled.";
            break;
          case "auth/popup-blocked":
            errorMessage = "Popup was blocked. Please allow popups and try again.";
            break;
          case "auth/cancelled-popup-request":
            errorMessage = "Another sign-in popup is already open.";
            break;
          case "auth/network-request-failed":
            errorMessage = "Network error. Please check your internet connection.";
            break;
          default:
            errorMessage = error.message || errorMessage;
        }
        
        showMessage(errorDiv, errorMessage, 'error');
      } finally {
        setButtonLoading(googleBtn, false, '', 'Continue with Google');
      }
    });
  }

  // Forgot Password functionality
  if (forgotPasswordLink) {
    forgotPasswordLink.addEventListener("click", async function (e) {
      e.preventDefault();
      
      const email = document.getElementById("email")?.value?.trim();
      
      if (!email) {
        showMessage(errorDiv, "Please enter your email address first.", 'warning');
        document.getElementById("email")?.focus();
        return;
      }

      if (!email.includes('@')) {
        showMessage(errorDiv, "Please enter a valid email address.", 'error');
        return;
      }

      try {
        await sendPasswordResetEmail(auth, email);
        showMessage(errorDiv, `Password reset email sent to ${email}. Check your inbox!`, 'success');
      } catch (error) {
        console.error("Password reset failed:", error);
        
        let errorMessage = "Failed to send password reset email.";
        
        if (error.code === "auth/user-not-found") {
          errorMessage = "No account found with this email address.";
        } else if (error.code === "auth/invalid-email") {
          errorMessage = "Invalid email address.";
        } else if (error.code === "auth/too-many-requests") {
          errorMessage = "Too many requests. Please wait a few minutes.";
        }
        
        showMessage(errorDiv, errorMessage, 'error');
      }
    });
  }

  // Add CSS for spinner animation
  const style = document.createElement("style");
  style.innerHTML = `
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .spinner {
      animation: spin 1s linear infinite;
    }
  `;
  document.head.appendChild(style);
});

// Enhanced logout function
async function logout() {
  try {
    await signOut(auth);
    console.log("✅ User signed out successfully");
    
    // Clear any stored data
    sessionStorage.clear();
    
    // Redirect with a slight delay to ensure sign out completes
    setTimeout(() => {
      window.location.href = "index.html";
    }, 100);
    
  } catch (error) {
    console.error("❌ Logout failed:", error);
    alert("Failed to sign out. Please try again.");
  }
}


window.authUtils = {
  logout,
  checkAuth,
  auth,
  validateUserProfile,
  showMessage
};
</script> 
</html>
