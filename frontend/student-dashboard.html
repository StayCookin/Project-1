<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard - InRent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      /* Custom styles to complement Tailwind */
      body {
        font-family: 'Inter', sans-serif; /* Default body font */
        background-color: #f0f2f5; /* Light gray background */
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-family: 'Poppins', sans-serif; /* Headings use Poppins */
      }
      /* Custom scrollbar for main content */
      .main-content::-webkit-scrollbar {
        width: 8px;
      }
      .main-content::-webkit-scrollbar-track {
        background: #e2e8f0; /* Light blue-gray */
        border-radius: 10px;
      }
      .main-content::-webkit-scrollbar-thumb {
        background: #94a3b8; /* Slate gray */
        border-radius: 10px;
      }
      .main-content::-webkit-scrollbar-thumb:hover {
        background: #64748b; /* Darker slate gray */
      }
      @media (max-width: 900px) {
        body,
        .centered-form-container,
        .main-content,
        .container,
        form {
          min-width: 90vw !important;
          max-width: 95vw !important;
          padding: 1.5rem 0.5rem !important;
        }
      }
      @media (max-width: 600px) {
        body,
        .centered-form-container,
        .main-content,
        .container,
        form {
          min-width: 100vw !important;
          max-width: 100vw !important;
          padding: 1.2rem 0.5rem !important;
          border-radius: 0 !important;
          box-shadow: none !important;
        }
        label,
        input,
        select,
        button,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          font-size: 1.1rem !important;
        }
      }
      @media (max-width: 400px) {
        body,
        .centered-form-container,
        .main-content,
        .container,
        form {
          padding: 0.5rem 0.2rem !important;
        }
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          font-size: 1.2rem !important;
        }
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    
    <div class="flex flex-grow bg-gray-100">
      <aside
        class="w-64 bg-white shadow-lg p-6 flex flex-col rounded-r-xl md:rounded-r-none"
      >
        <div class="sidebar-header text-center mb-8">
          <img
            src="https://placehold.co/80x80/16A34A/FFFFFF?text=S"
            alt="Profile"
            class="profile-image w-20 h-20 rounded-full mx-auto mb-3 object-cover border-4 border-green-200"
          />
          <h2 class="text-xl font-semibold text-gray-800" id="sidebarWelcome">
            Welcome, Student
          </h2>
        </div>
        <ul class="sidebar-menu flex-grow space-y-2">
          <li>
            <a
              href="#"
              class="flex items-center p-3 rounded-lg text-green-700 bg-green-50 font-medium hover:bg-green-100 transition-colors duration-200"
              ><i class="fas fa-home mr-3"></i> Dashboard</a
            >
          </li>
          <li>
            <a
              href="marketplace.html"
              class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200"
              ><i class="fas fa-search mr-3"></i> Find Properties</a
            >
          </li>
          <li>
            <a
              href="saved-properties.html"
              class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200"
              ><i class="fas fa-heart mr-3"></i> Saved Properties</a
            >
          </li>
          <li>
            <a
              href="viewings.html"
              class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200"
              ><i class="fas fa-calendar mr-3"></i> Viewings</a
            >
          </li>
          <li>
            <a
              href="messages.html"
              class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200"
              ><i class="fas fa-envelope mr-3"></i> Messages</a
            >
          </li>
          <li>
            <a
              href="user-profile.html"
              class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200"
              ><i class="fas fa-user mr-3"></i> Profile</a
            >
          </li>
          <li>
            <a
              href="settings.html"
              class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200"
              ><i class="fas fa-cog mr-3"></i> Settings</a
            >
          </li>
          <li class="mt-auto pt-4">
            <a
              href="index.html"
              id="logoutBtn"
              class="flex items-center p-3 rounded-lg text-red-600 hover:bg-red-50 transition-colors duration-200"
              ><i class="fas fa-sign-out-alt mr-3"></i> Logout</a
            >
          </li>
        </ul>
      </aside>

      <main class="main-content flex-grow p-6 overflow-y-auto">
        <div
          class="dashboard-header bg-white p-6 rounded-xl shadow-md mb-6 flex flex-col md:flex-row items-center justify-between gap-4"
        >
          <div class="search-container w-full md:w-2/3 flex flex-col gap-3">
            <div
              class="search-bar flex items-center border border-gray-300 rounded-lg p-2 bg-gray-50 focus-within:ring-2 focus-within:ring-green-300 transition-all duration-200"
            >
              <i class="fas fa-search text-gray-400 mr-2"></i>
              <input
                type="text"
                class="search-input flex-grow bg-transparent outline-none text-gray-800 placeholder-gray-400"
                placeholder="Search properties in Gaborone..."
                id="propertySearchInput"
              />
            </div>
            <div
              class="search-filters grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3"
              id="searchFilters"
            >
              <select
                class="filter-select p-2 border border-gray-300 rounded-lg bg-white text-gray-700 focus:ring-2 focus:ring-green-300 focus:border-green-300 transition-all duration-200"
              >
                <option value="">All Amenities</option>
                <option value="wifi">WiFi</option>
                <option value="parking">Parking</option>
                <option value="furnished">Furnished</option>
                <option value="security">Security</option>
                <option value="laundry">Laundry</option>
              </select>
              <select
                class="filter-select p-2 border border-gray-300 rounded-lg bg-white text-gray-700 focus:ring-2 focus:ring-green-300 focus:border-green-300 transition-all duration-200"
              >
                <option value="">All Areas</option>
                <option value="ub">Near UB</option>
                <option value="baisago">Near Baisago</option>
                <option value="botho">Near Botho</option>
                <option value="riverwalk">Riverwalk</option>
                <option value="gamecity">Game City</option>
              </select>
              <select
                class="filter-select p-2 border border-gray-300 rounded-lg bg-white text-gray-700 focus:ring-2 focus:ring-green-300 focus:border-green-300 transition-all duration-200"
              >
                <option value="">Budget Range</option>
                <option value="0-2000">P0 - P2,000</option>
                <option value="2000-4000">P2,000 - P4,000</option>
                <option value="4000-6000">P4,000 - P6,000</option>
                <option value="6000+">P6,000+</option>
              </select>
              <select
                class="filter-select p-2 border border-gray-300 rounded-lg bg-white text-gray-700 focus:ring-2 focus:ring-green-300 focus:border-green-300 transition-all duration-200"
              >
                <option value="">Property Condition</option>
                <option value="new">New</option>
                <option value="renovated">Renovated</option>
                <option value="good">Good</option>
                <option value="needs-work">Needs Work</option>
              </select>
            </div>
          </div>
          <div class="header-actions flex items-center space-x-4">
            <div class="notifications-container relative">
              <div
                class="notifications cursor-pointer relative"
                id="notificationToggle"
              >
                <i
                  class="fas fa-bell text-gray-600 text-xl hover:text-green-600 transition-colors duration-200"
                ></i>
                <span
                  class="notification-badge absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center"
                  id="notificationBadge"
                  >0</span
                >
              </div>
              <div
                class="notification-dropdown absolute right-0 mt-3 w-72 bg-white rounded-lg shadow-xl z-10 hidden"
                id="notificationDropdown"
              >
                <div class="notification-tabs flex border-b border-gray-200">
                  <div
                    class="notification-tab active flex-1 text-center p-3 cursor-pointer text-green-700 font-semibold border-b-2 border-green-600"
                    data-tab="messages"
                    href="messages.html"
                  >
                    Messages
                  </div>
                  <div
                    class="notification-tab flex-1 text-center p-3 cursor-pointer text-gray-600 hover:text-gray-800"
                    data-tab="properties"
                  >
                    Properties
                  </div>
                </div>
                <div
                  class="notification-list p-3 max-h-60 overflow-y-auto"
                  id="notificationList"
                >
                  <p class="text-center text-gray-500 py-4">
                    No new notifications.
                  </p>
                  </div>
              </div>
            </div>
            <div class="profile-menu relative">
              <img
                src="https://placehold.co/40x40/16A34A/FFFFFF?text=S"
                alt="Profile"
                class="profile-image-small w-10 h-10 rounded-full object-cover cursor-pointer border-2 border-green-300"
                id="profileMenuToggle"
              />
              <div
                class="profile-dropdown absolute right-0 mt-3 w-48 bg-white rounded-lg shadow-xl z-10 hidden"
              >
                <a
                  href="user-profile.html"
                  class="flex items-center p-3 text-gray-700 hover:bg-gray-100 rounded-t-lg transition-colors duration-200"
                  ><i class="fas fa-user mr-3"></i> Profile</a
                >
                <a
                  href="settings.html"
                  class="flex items-center p-3 text-gray-700 hover:bg-gray-100 transition-colors duration-200"
                  ><i class="fas fa-cog mr-3"></i> Settings</a
                >
                <a
                  href="#"
                  id="headerLogoutBtn"
                  class="flex items-center p-3 text-red-600 hover:bg-red-50 rounded-b-lg transition-colors duration-200"
                  ><i class="fas fa-sign-out-alt mr-3"></i> Logout</a
                >
              </div>
            </div>
          </div>
        </div>
        <div
          class="dashboard-cards grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
          id="dashboardCards"
        >
          <div
            class="dashboard-card bg-white p-6 rounded-xl shadow-md text-center animate-pulse"
          >
            <div class="h-6 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
            <div class="h-10 bg-gray-300 rounded w-1/2 mx-auto"></div>
          </div>
          <div
            class="dashboard-card bg-white p-6 rounded-xl shadow-md text-center animate-pulse"
          >
            <div class="h-6 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
            <div class="h-10 bg-gray-300 rounded w-1/2 mx-auto"></div>
          </div>
          <div
            class="dashboard-card bg-white p-6 rounded-xl shadow-md text-center animate-pulse"
          >
            <div class="h-6 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
            <div class="h-10 bg-gray-300 rounded w-1/2 mx-auto"></div>
          </div>
          <div
            class="dashboard-card bg-white p-6 rounded-xl shadow-md text-center animate-pulse"
          >
            <div class="h-6 bg-gray-200 rounded w-3/4 mx-auto mb-2"></div>
            <div class="h-10 bg-gray-300 rounded w-1/2 mx-auto"></div>
          </div>
          </div>
        <div class="property-listings bg-white p-6 rounded-xl shadow-md">
          <div
            class="property-listings-header flex items-center justify-between mb-6"
          >
            <h2 class="text-2xl font-bold text-gray-800">
              Recommended Properties
              <span
                class="location-badge bg-green-100 text-green-700 text-sm font-medium px-3 py-1 rounded-full ml-2"
                >Gaborone</span
              >
            </h2>
            <a
              href="marketplace.html"
              class="text-green-600 hover:text-green-800 font-medium transition-colors duration-200"
              >View All <i class="fas fa-arrow-right ml-1 text-sm"></i
            ></a>
          </div>
          <div
            class="property-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
            id="propertyGrid"
          >
            <div
              class="property-card bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden animate-pulse"
            >
              <div class="w-full h-48 bg-gray-200"></div>
              <div class="p-4">
                <div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
                <div class="h-4 bg-gray-200 rounded w-1/3 mb-4"></div>
                <div class="flex space-x-2">
                  <div class="h-10 bg-gray-200 rounded w-2/3"></div>
                  <div class="h-10 bg-gray-200 rounded w-1/3"></div>
                </div>
              </div>
            </div>
            <div
              class="property-card bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden animate-pulse"
            >
              <div class="w-full h-48 bg-gray-200"></div>
              <div class="p-4">
                <div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
                <div class="h-4 bg-gray-200 rounded w-1/3 mb-4"></div>
                <div class="flex space-x-2">
                  <div class="h-10 bg-gray-200 rounded w-2/3"></div>
                  <div class="h-10 bg-gray-200 rounded w-1/3"></div>
                </div>
              </div>
            </div>
            <div
              class="property-card bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden animate-pulse"
            >
              <div class="w-full h-48 bg-gray-200"></div>
              <div class="p-4">
                <div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
                <div class="h-4 bg-gray-200 rounded w-1/3 mb-4"></div>
                <div class="flex space-x-2">
                  <div class="h-10 bg-gray-200 rounded w-2/3"></div>
                  <div class="h-10 bg-gray-200 rounded w-1/3"></div>
                </div>
              </div>
            </div>
            </div>
        </div>
      </main>
    </div>
    <footer class="footer bg-gray-800 text-white p-8 mt-auto">
      <div
        class="footer-container max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8"
      >
        <div class="footer-section">
          <h3 class="text-xl font-semibold mb-4 text-green-300">Quick Links</h3>
          <ul class="footer-links space-y-2">
            <li>
              <a
                href="index.html"
                class="flex items-center text-gray-300 hover:text-white transition-colors duration-200"
                ><i class="fas fa-home mr-2"></i> Home</a
              >
            </li>
            <li>
              <a
                href="student-dashboard.html"
                class="flex items-center text-gray-300 hover:text-white transition-colors duration-200"
                ><i class="fas fa-user mr-2"></i> Dashboard</a
              >
            </li>
            <li>
              <a
                href="contact.html"
                class="flex items-center text-gray-300 hover:text-white transition-colors duration-200"
                ><i class="fas fa-envelope mr-2"></i> Contact Us</a
              >
            </li>
          </ul>
        </div>
        <div class="footer-section">
          <h3 class="text-xl font-semibold mb-4 text-green-300">
            Help & Support
          </h3>
          <ul class="footer-links space-y-2">
            <li>
              <a
                href="faq.html"
                class="flex items-center text-gray-300 hover:text-white transition-colors duration-200"
                ><i class="fas fa-question-circle mr-2"></i> FAQ</a
              >
            </li>
            <li>
              <a
                href="contact.html"
                class="flex items-center text-gray-300 hover:text-white transition-colors duration-200"
                ><i class="fas fa-headset mr-2"></i> Support</a
              >
            </li>
            <li>
              <a
                href="reset-password.html"
                class="flex items-center text-gray-300 hover:text-white transition-colors duration-200"
                ><i class="fas fa-key mr-2"></i> Reset Password</a
              >
            </li>
          </ul>
        </div>
        <div class="footer-section">
          <h3 class="text-xl font-semibold mb-4 text-green-300">Legal</h3>
          <ul class="footer-links space-y-2">
            <li>
              <a
                href="terms.html"
                class="flex items-center text-gray-300 hover:text-white transition-colors duration-200"
                ><i class="fas fa-file-contract mr-2"></i> Terms of Service</a
              >
            </li>
            <li>
              <a
                href="privacy.html"
                class="flex items-center text-gray-300 hover:text-white transition-colors duration-200"
                ><i class="fas fa-shield-alt mr-2"></i> Privacy Policy</a
              >
            </li>
          </ul>
        </div>
      </div>
      <div
        class="footer-bottom text-center text-gray-400 mt-8 pt-4 border-t border-gray-700"
      >
        <p>&copy; 2025 InRent. All rights reserved.</p>
      </div>
    </footer>
    <div
      class="modal fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden"
      id="review-modal"
    >
      <div
        class="modal-content bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg relative transform scale-95 opacity-0 transition-all duration-300 ease-out"
        style="max-width: 550px"
      >
        <span
          class="modal-close absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-3xl font-light cursor-pointer"
          >&times;</span
        >
        <h3
          id="reviewModalTitle"
          class="text-2xl font-bold text-gray-800 mb-6 text-center"
        >
          Write a Review
        </h3>
        <form id="reviewForm" class="space-y-6">
          <div class="form-group">
            <label class="block text-gray-700 text-sm font-medium mb-2"
              >Your Rating:</label
            >
            <div
              class="rating-stars flex justify-center space-x-1 text-yellow-400 text-2xl"
              id="reviewRatingStars"
            >
              <i class="fas fa-star cursor-pointer hover:text-yellow-500"></i>
              <i class="fas fa-star cursor-pointer hover:text-yellow-500"></i>
              <i class="fas fa-star cursor-pointer hover:text-yellow-500"></i>
              <i class="far fa-star cursor-pointer hover:text-yellow-500"></i>
              <i class="far fa-star cursor-pointer hover:text-yellow-500"></i>
            </div>
          </div>
          <div class="form-group">
            <label
              for="reviewText"
              class="block text-gray-700 text-sm font-medium mb-2"
              >Your Review:</label
            >
            <textarea
              id="reviewText"
              required
              rows="4"
              class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
              placeholder="Share your experience..."
            ></textarea>
          </div>
          <button
            type="submit"
            class="btn w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105"
          >
            Submit Review
          </button>
          <div
            class="success-message text-green-600 text-center mt-4 hidden"
            id="reviewFormSuccess"
          >
            Review submitted successfully!
          </div>
        </form>
      </div>
    </div>
    <script type="module" defer>
      // Enhanced Student Dashboard - Firebase Integrated
// Make sure Firebase is initialized before this script runs

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut,
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  collection,
  query,
  where,
  getDocs,
  addDoc,
  setDoc,
  deleteDoc,
  updateDoc,
  orderBy,
  limit,
  onSnapshot,
  serverTimestamp,
  FieldValue
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAXKk5gRjwSGK_g9f_HP_f4y4445e_8l4w",
  authDomain: "project-1-1e31c.firebaseapp.com",
  projectId: "project-1-1e31c",
  storageBucket: "project-1-1e31c.firebasestorage.app",
  messagingSenderId: "658275930203",
  appId: "1:658275930203:web:afc2e2a249509737b0ef7e",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

class StudentDashboard {
  constructor() {
    this.currentUser = null;
    this.userProfile = null;
    this.currentRating = 0;
    this.init();
  }

  async init() {
    try {
      // Wait for Firebase Auth to initialize
      await this.waitForFirebaseAuth();
      this.setupEventListeners();
    } catch (error) {
      console.error('Dashboard initialization failed:', error);
      this.handleError('Failed to initialize dashboard');
    }
  }

  // Wait for Firebase Auth to be ready
  waitForFirebaseAuth() {
    return new Promise((resolve, reject) => {
      const timeout = setTimeout(() => {
        reject(new Error('Firebase Auth timeout'));
      }, 10000);

      const unsubscribe = auth.onAuthStateChanged(async (user) => {
        clearTimeout(timeout);
        unsubscribe();
        
        if (user) {
          await this.handleAuthenticatedUser(user);
          resolve();
        } else {
          this.redirectToLogin();
          reject(new Error('User not authenticated'));
        }
      });
    });
  }

  async handleAuthenticatedUser(user) {
    try {
      this.currentUser = user;
      
      // Get user role and verify access
      const userRole = await this.getUserRole(user);
      
      if (userRole !== 'student') {
        this.redirectBasedOnRole(userRole);
        return;
      }

      // Load dashboard data
      await Promise.all([
        this.fetchUserProfile(user),
        this.fetchDashboardStats(user),
        this.fetchProperties(),
        this.fetchReviews()
      ]);

    } catch (error) {
      console.error('Error handling authenticated user:', error);
      this.handleError('Failed to load user data');
    }
  }

  async getUserRole(user) {
    try {
      const idTokenResult = await user.getIdTokenResult(true);
      return idTokenResult.claims.role || null;
    } catch (error) {
      console.error('Error getting user role:', error);
      // Fallback: check Firestore user document
      try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        return userDoc.exists ? userDoc.data().role : null;
      } catch (firestoreError) {
        console.error('Error fetching role from Firestore:', firestoreError);
        return null;
      }
    }
  }

  redirectBasedOnRole(role) {
    switch (role) {
      case 'landlord':
        window.location.href = 'landlord-dashboard.html';
        break;
      case 'admin':
        window.location.href = 'admin-dashboard.html';
        break;
      default:
        console.warn('Unknown user role:', role);
        this.signOut();
    }
  }

  redirectToLogin() {
    window.location.href = 'login.html';
  }

  async fetchUserProfile(user) {
    try {
      const userDoc = await db.collection('users').doc(user.uid).get();
      this.userProfile = userDoc.exists ? userDoc.data() : {};
      
      const displayName = this.userProfile.firstName || user.displayName || 'Student';
      const profileImageUrl = this.userProfile.profilePictureUrl || 
                             user.photoURL || 
                             `https://placehold.co/80x80/16A34A/FFFFFF?text=${displayName.charAt(0)}`;

      // Update UI elements safely
      this.updateElementText('sidebarWelcome', `Welcome, ${displayName}`);
      this.updateElementSrc('.sidebar-header .profile-image', profileImageUrl);
      this.updateElementSrc('.profile-menu .profile-image-small', profileImageUrl);
      
    } catch (error) {
      console.error('Failed to fetch user profile:', error);
      // Fallback to Firebase Auth data
      const displayName = user.displayName || 'Student';
      this.updateElementText('sidebarWelcome', `Welcome, ${displayName}`);
    }
  }

  async fetchDashboardStats(user) {
    try {
      // Fetch various stats in parallel
      const [savedProperties, scheduledViewings, unreadMessages, reviewsCount] = await Promise.all([
        this.getSavedPropertiesCount(user.uid),
        this.getScheduledViewingsCount(user.uid),
        this.getUnreadMessagesCount(user.uid),
        this.getUserReviewsCount(user.uid)
      ]);

      const stats = {
        savedProperties,
        scheduledViewings,
        unreadMessages,
        reviewsCount
      };

      this.renderDashboardCards(stats);
      this.updateNotificationBadge(stats.unreadMessages);

    } catch (error) {
      console.error('Failed to fetch dashboard stats:', error);
      this.renderDefaultDashboardCards();
    }
  }

  async getSavedPropertiesCount(userId) {
    try {
      const snapshot = await db.collection('savedProperties')
        .where('userId', '==', userId)
        .get();
      return snapshot.size;
    } catch (error) {
      console.error('Error fetching saved properties count:', error);
      return 0;
    }
  }

  async getScheduledViewingsCount(userId) {
    try {
      const snapshot = await db.collection('viewings')
        .where('studentId', '==', userId)
        .where('status', '==', 'scheduled')
        .get();
      return snapshot.size;
    } catch (error) {
      console.error('Error fetching scheduled viewings count:', error);
      return 0;
    }
  }

  async getUnreadMessagesCount(userId) {
    try {
      const snapshot = await db.collection('messages')
        .where('recipientId', '==', userId)
        .where('read', '==', false)
        .get();
      return snapshot.size;
    } catch (error) {
      console.error('Error fetching unread messages count:', error);
      return 0;
    }
  }

  async getUserReviewsCount(userId) {
    try {
      const snapshot = await db.collection('reviews')
        .where('userId', '==', userId)
        .get();
      return snapshot.size;
    } catch (error) {
      console.error('Error fetching user reviews count:', error);
      return 0;
    }
  }

  renderDashboardCards(stats) {
    const dashboardCardsContainer = document.getElementById('dashboardCards');
    if (!dashboardCardsContainer) return;

    dashboardCardsContainer.innerHTML = `
      <div class="dashboard-card bg-white p-6 rounded-xl shadow-md text-center transform hover:scale-105 transition-transform duration-200 cursor-pointer" data-action="saved-properties">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">
          <i class="fas fa-heart text-red-500 mr-2"></i> Saved Properties
        </h3>
        <p class="text-4xl font-bold text-gray-900">${stats.savedProperties}</p>
      </div>
      <div class="dashboard-card bg-white p-6 rounded-xl shadow-md text-center transform hover:scale-105 transition-transform duration-200 cursor-pointer" data-action="scheduled-viewings">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">
          <i class="fas fa-calendar text-blue-500 mr-2"></i> Scheduled Viewings
        </h3>
        <p class="text-4xl font-bold text-gray-900">${stats.scheduledViewings}</p>
      </div>
      <div class="dashboard-card bg-white p-6 rounded-xl shadow-md text-center transform hover:scale-105 transition-transform duration-200 cursor-pointer" data-action="messages">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">
          <i class="fas fa-envelope text-green-500 mr-2"></i> Messages
          ${stats.unreadMessages > 0 ? '<span class="notification-asterisk text-red-500 text-xl font-bold">*</span>' : ''}
        </h3>
        <p class="text-4xl font-bold text-gray-900">${stats.unreadMessages}</p>
      </div>
      <div class="dashboard-card bg-white p-6 rounded-xl shadow-md text-center transform hover:scale-105 transition-transform duration-200 cursor-pointer" data-action="reviews">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">
          <i class="fas fa-star text-yellow-500 mr-2"></i> Reviews
        </h3>
        <p class="text-4xl font-bold text-gray-900">${stats.reviewsCount}</p>
      </div>
    `;

    // Add click handlers for dashboard cards
    this.setupDashboardCardActions();
  }

  renderDefaultDashboardCards() {
    const dashboardCardsContainer = document.getElementById('dashboardCards');
    if (!dashboardCardsContainer) return;

    dashboardCardsContainer.innerHTML = `
      <div class="dashboard-card bg-white p-6 rounded-xl shadow-md text-center">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">
          <i class="fas fa-heart text-red-500 mr-2"></i> Saved Properties
        </h3>
        <p class="text-4xl font-bold text-gray-400">--</p>
      </div>
      <div class="dashboard-card bg-white p-6 rounded-xl shadow-md text-center">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">
          <i class="fas fa-calendar text-blue-500 mr-2"></i> Scheduled Viewings
        </h3>
        <p class="text-4xl font-bold text-gray-400">--</p>
      </div>
      <div class="dashboard-card bg-white p-6 rounded-xl shadow-md text-center">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">
          <i class="fas fa-envelope text-green-500 mr-2"></i> Messages
        </h3>
        <p class="text-4xl font-bold text-gray-400">--</p>
      </div>
      <div class="dashboard-card bg-white p-6 rounded-xl shadow-md text-center">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">
          <i class="fas fa-star text-yellow-500 mr-2"></i> Reviews
        </h3>
        <p class="text-4xl font-bold text-gray-400">--</p>
      </div>
    `;
  }

  setupDashboardCardActions() {
    const dashboardCards = document.querySelectorAll('.dashboard-card[data-action]');
    dashboardCards.forEach(card => {
      card.addEventListener('click', (e) => {
        const action = card.getAttribute('data-action');
        this.handleDashboardCardClick(action);
      });
    });
  }

  handleDashboardCardClick(action) {
    switch (action) {
      case 'saved-properties':
        this.navigateToSavedProperties();
        break;
      case 'scheduled-viewings':
        this.navigateToScheduledViewings();
        break;
      case 'messages':
        this.navigateToMessages();
        break;
      case 'reviews':
        this.openReviewModal();
        break;
      default:
        console.warn('Unknown dashboard action:', action);
    }
  }

  async fetchProperties() {
    try {
      this.showLoadingState('propertyGrid');
      
      // Fetch recommended properties from Firestore
      const propertiesSnapshot = await db.collection('properties')
        .where('status', '==', 'available')
        .where('featured', '==', true)
        .limit(9)
        .get();

      const properties = [];
      propertiesSnapshot.forEach(doc => {
        properties.push({ id: doc.id, ...doc.data() });
      });

      this.renderProperties(properties);

    } catch (error) {
      console.error('Failed to fetch properties:', error);
      this.showErrorState('propertyGrid', 'Failed to load properties');
    }
  }

  renderProperties(properties) {
    const propertyGridContainer = document.getElementById('propertyGrid');
    if (!propertyGridContainer) return;

    propertyGridContainer.innerHTML = '';

    if (properties.length === 0) {
      propertyGridContainer.innerHTML = `
        <div class="col-span-full text-center py-12">
          <i class="fas fa-home text-gray-300 text-6xl mb-4"></i>
          <p class="text-gray-600 text-lg">No recommended properties available at the moment.</p>
          <button onclick="window.location.href='properties.html'" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
            Browse All Properties
          </button>
        </div>
      `;
      return;
    }

    properties.forEach(property => {
      const propertyCard = this.createPropertyCard(property);
      propertyGridContainer.insertAdjacentHTML('beforeend', propertyCard);
    });

    // Setup property card interactions
    this.setupPropertyCardActions();
  }

  createPropertyCard(property) {
    return `
      <div class="property-card bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden transform hover:scale-105 transition-transform duration-200" data-property-id="${property.id}">
        <div class="relative">
          <img
            src="${property.imageUrl || 'https://placehold.co/400x250/22C55E/FFFFFF?text=Property'}"
            alt="${property.title || 'Property Image'}"
            class="property-image w-full h-48 object-cover"
            onerror="this.src='https://placehold.co/400x250/22C55E/FFFFFF?text=Property'"
          />
          <div class="absolute top-2 right-2">
            <button class="save-property-btn ${this.isPropertySaved(property.id) ? 'saved' : ''} bg-white bg-opacity-80 hover:bg-opacity-100 p-2 rounded-full transition-all duration-200" data-property-id="${property.id}">
              <i class="fas fa-heart ${this.isPropertySaved(property.id) ? 'text-red-500' : 'text-gray-400'}"></i>
            </button>
          </div>
        </div>
        <div class="property-details p-4">
          <div class="property-price text-xl font-bold text-green-600 mb-1">
            P${property.price ? property.price.toLocaleString() : 'N/A'}/month
          </div>
          <h3 class="property-title text-lg font-semibold text-gray-800 mb-1">
            ${property.title || 'Untitled Property'}
          </h3>
          <p class="property-location text-gray-600 text-sm mb-3 flex items-center">
            <i class="fas fa-map-marker-alt mr-1"></i>
            ${property.location || 'Location not specified'}
          </p>
          <div class="property-features flex flex-wrap gap-x-4 gap-y-2 text-gray-700 text-sm mb-4">
            <span class="flex items-center">
              <i class="fas fa-bed text-gray-500 mr-1"></i> ${property.beds || 'N/A'} Beds
            </span>
            <span class="flex items-center">
              <i class="fas fa-bath text-gray-500 mr-1"></i> ${property.baths || 'N/A'} Bath
            </span>
            <span class="flex items-center">
              <i class="fas fa-ruler-combined text-gray-500 mr-1"></i> ${property.sqft || 'N/A'} sqft
            </span>
          </div>
          <div class="property-actions flex space-x-2">
            <button class="view-property-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200" data-property-id="${property.id}">
              <i class="fas fa-eye mr-2"></i> View Details
            </button>
            <button class="schedule-viewing-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200" data-property-id="${property.id}">
              <i class="fas fa-calendar-plus mr-1"></i> Schedule
            </button>
          </div>
        </div>
      </div>
    `;
  }

  setupPropertyCardActions() {
    // View property details
    document.querySelectorAll('.view-property-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const propertyId = btn.getAttribute('data-property-id');
        this.viewPropertyDetails(propertyId);
      });
    });

    // Save/unsave property
    document.querySelectorAll('.save-property-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const propertyId = btn.getAttribute('data-property-id');
        this.toggleSaveProperty(propertyId);
      });
    });

    // Schedule viewing
    document.querySelectorAll('.schedule-viewing-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const propertyId = btn.getAttribute('data-property-id');
        this.scheduleViewing(propertyId);
      });
    });
  }

  async toggleSaveProperty(propertyId) {
    if (!this.currentUser) {
      this.showNotification('Please log in to save properties', 'error');
      return;
    }

    try {
      const savedPropertyRef = db.collection('savedProperties').doc(`${this.currentUser.uid}_${propertyId}`);
      const savedPropertyDoc = await savedPropertyRef.get();

      if (savedPropertyDoc.exists) {
        // Unsave property
        await savedPropertyRef.delete();
        this.updateSaveButton(propertyId, false);
        this.showNotification('Property removed from saved list', 'success');
      } else {
        // Save property
        await savedPropertyRef.set({
          userId: this.currentUser.uid,
          propertyId: propertyId,
          savedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        this.updateSaveButton(propertyId, true);
        this.showNotification('Property saved successfully', 'success');
      }

      // Refresh dashboard stats
      await this.fetchDashboardStats(this.currentUser);

    } catch (error) {
      console.error('Error toggling save property:', error);
      this.showNotification('Failed to update saved properties', 'error');
    }
  }

  isPropertySaved(propertyId) {
    // This would be checked during initial load
    // For now, return false - implement proper check during property rendering
    return false;
  }

  updateSaveButton(propertyId, isSaved) {
    const saveBtn = document.querySelector(`.save-property-btn[data-property-id="${propertyId}"]`);
    if (saveBtn) {
      const icon = saveBtn.querySelector('i');
      if (isSaved) {
        saveBtn.classList.add('saved');
        icon.classList.remove('text-gray-400');
        icon.classList.add('text-red-500');
      } else {
        saveBtn.classList.remove('saved');
        icon.classList.remove('text-red-500');
        icon.classList.add('text-gray-400');
      }
    }
  }

  viewPropertyDetails(propertyId) {
    window.location.href = `property-details.html?id=${propertyId}`;
  }

  async scheduleViewing(propertyId) {
    // Open scheduling modal or navigate to scheduling page
    // For now, simple alert - replace with proper modal
    const result = confirm('Would you like to schedule a viewing for this property?');
    if (result) {
      try {
        // Create viewing request
        await db.collection('viewingRequests').add({
          studentId: this.currentUser.uid,
          propertyId: propertyId,
          status: 'pending',
          requestedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        this.showNotification('Viewing request submitted successfully', 'success');
        await this.fetchDashboardStats(this.currentUser);
        
      } catch (error) {
        console.error('Error scheduling viewing:', error);
        this.showNotification('Failed to schedule viewing', 'error');
      }
    }
  }

  navigateToSavedProperties() {
    window.location.href = 'saved-properties.html';
  }

  navigateToScheduledViewings() {
    window.location.href = 'scheduled-viewings.html';
  }

  navigateToMessages() {
    window.location.href = 'messages.html';
  }

  setupEventListeners() {
    // Notification dropdown
    this.setupDropdown('notificationToggle', 'notificationDropdown');
    
    // Profile menu dropdown
    this.setupDropdown('profileMenuToggle', '.profile-menu .profile-dropdown');

    // Logout buttons
    this.setupLogoutButtons();

    // Review modal
    this.setupReviewModal();

    // Search functionality
    this.setupSearch();
  }

  setupDropdown(toggleId, dropdownSelector) {
    const toggle = document.getElementById(toggleId);
    const dropdown = document.querySelector(dropdownSelector) || document.getElementById(dropdownSelector);

    if (toggle && dropdown) {
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('hidden');
      });

      document.addEventListener('click', (e) => {
        if (!toggle.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.add('hidden');
        }
      });
    }
  }

  setupLogoutButtons() {
    const logoutButtons = ['logoutBtn', 'headerLogoutBtn'];
    
    logoutButtons.forEach(btnId => {
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          this.signOut();
        });
      }
    });
  }

  async signOut() {
    try {
      await auth.signOut();
      window.location.href = 'index.html';
    } catch (error) {
      console.error('Error signing out:', error);
      this.showNotification('Failed to sign out. Please try again.', 'error');
    }
  }

  setupReviewModal() {
    const reviewModal = document.getElementById('review-modal');
    const modalCloseBtn = reviewModal?.querySelector('.modal-close');
    const reviewForm = document.getElementById('reviewForm');

    if (modalCloseBtn) {
      modalCloseBtn.addEventListener('click', () => this.closeReviewModal());
    }

    if (reviewModal) {
      reviewModal.addEventListener('click', (e) => {
        if (e.target === reviewModal) {
          this.closeReviewModal();
        }
      });
    }

    if (reviewForm) {
      reviewForm.addEventListener('submit', (e) => this.handleReviewSubmission(e));
    }

    this.setupStarRating();
  }

  setupStarRating() {
    const reviewRatingStars = document.getElementById('reviewRatingStars');
    if (reviewRatingStars) {
      Array.from(reviewRatingStars.children).forEach((star, index) => {
        star.addEventListener('click', () => {
          this.currentRating = index + 1;
          this.updateStarRating();
        });
      });
    }
  }

  updateStarRating() {
    const reviewRatingStars = document.getElementById('reviewRatingStars');
    if (reviewRatingStars) {
      Array.from(reviewRatingStars.children).forEach((star, index) => {
        if (index < this.currentRating) {
          star.classList.remove('far');
          star.classList.add('fas');
        } else {
          star.classList.remove('fas');
          star.classList.add('far');
        }
      });
    }
  }

  openReviewModal() {
    const reviewModal = document.getElementById('review-modal');
    if (reviewModal) {
      reviewModal.classList.remove('hidden');
      setTimeout(() => {
        const modalContent = reviewModal.querySelector('.modal-content');
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');
      }, 10);
    }
  }

  closeReviewModal() {
    const reviewModal = document.getElementById('review-modal');
    if (reviewModal) {
      const modalContent = reviewModal.querySelector('.modal-content');
      modalContent.classList.remove('opacity-100', 'scale-100');
      modalContent.classList.add('opacity-0', 'scale-95');
      
      setTimeout(() => {
        reviewModal.classList.add('hidden');
        document.getElementById('reviewFormSuccess')?.classList.add('hidden');
        document.getElementById('reviewForm')?.reset();
        this.currentRating = 0;
        this.updateStarRating();
      }, 300);
    }
  }

  async handleReviewSubmission(event) {
    event.preventDefault();
    
    if (!this.currentUser) {
      this.showNotification('You must be logged in to submit a review', 'error');
      return;
    }

    if (this.currentRating === 0) {
      this.showNotification('Please select a rating', 'error');
      return;
    }

    const reviewText = document.getElementById('reviewText').value.trim();
    if (!reviewText) {
      this.showNotification('Please write a review', 'error');
      return;
    }

    try {
      // Add review to Firestore
      await db.collection('reviews').add({
        userId: this.currentUser.uid,
        userEmail: this.currentUser.email,
        userName: this.userProfile?.firstName || this.currentUser.displayName || 'Anonymous',
        rating: this.currentRating,
        reviewText: reviewText,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'pending' // For moderation if needed
      });

      document.getElementById('reviewFormSuccess').classList.remove('hidden');
      this.showNotification('Review submitted successfully', 'success');
      
      // Refresh dashboard stats
      await this.fetchDashboardStats(this.currentUser);
      
      // Close modal after delay
      setTimeout(() => this.closeReviewModal(), 2000);

    } catch (error) {
      console.error('Error submitting review:', error);
      this.showNotification('Failed to submit review. Please try again.', 'error');
    }
  }

  setupSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');

    if (searchInput && searchBtn) {
      const handleSearch = () => {
        const query = searchInput.value.trim();
        if (query) {
          window.location.href = `properties.html?search=${encodeURIComponent(query)}`;
        }
      };

      searchBtn.addEventListener('click', handleSearch);
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleSearch();
        }
      });
    }
  }

  showLoadingState(containerId) {
    const container = document.getElementById(containerId);
    if (container) {
      container.innerHTML = `
        <div class="col-span-full text-center py-12">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"></div>
          <p class="text-gray-600 mt-4">Loading...</p>
        </div>
      `;
    }
  }

  showErrorState(containerId, message) {
    const container = document.getElementById(containerId);
    if (container) {
      container.innerHTML = `
        <div class="col-span-full text-center py-12">
          <i class="fas fa-exclamation-triangle text-red-500 text-6xl mb-4"></i>
          <p class="text-red-600 text-lg">${message}</p>
          <button onclick="location.reload()" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition-colors">
            Try Again
          </button>
        </div>
      `;
    }
  }

  updateElementText(selector, text) {
    const element = document.getElementById(selector) || document.querySelector(selector);
    if (element) {
      element.textContent = text;
    }
  }

  updateElementSrc(selector, src) {
    const element = document.querySelector(selector);
    if (element) {
      element.src = src;
    }
  }

  updateNotificationBadge(count) {
    const badge = document.getElementById('notificationBadge');
    if (badge) {
      badge.textContent = count;
      badge.style.display = count > 0 ? 'block' : 'none';
    }
  }

  showNotification(message, type = 'info') {
    // Create and show a notification toast
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
      type === 'success' ? 'bg-green-500 text-white' :
      type === 'error' ? 'bg-red-500 text-white' :
      'bg-blue-500 text-white'
    }`;
    notification.innerHTML = `
      <div class="flex items-center">
        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle mr-2"></i>
        ${message}
        <button class="ml-4 text-white hover:text-gray-200" onclick="this.parentElement.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
      notification.classList.remove('translate-x-full');
    }, 100);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      notification.classList.add('translate-x-full');
      setTimeout(() => notification.remove(), 300);
    }, 5000);
  }

  handleError(message) {
    console.error(message);
    this.showNotification(message, 'error');
    
    // Show error state in main content area
    const mainContent = document.querySelector('.main-content') || document.body;
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed inset-0 bg-red-50 flex items-center justify-center z-40';
    errorDiv.innerHTML = `
      <div class="text-center p-8">
        <i class="fas fa-exclamation-triangle text-red-500 text-6xl mb-4"></i>
        <h2 class="text-2xl font-bold text-red-700 mb-2">Dashboard Error</h2>
        <p class="text-red-600 mb-4">${message}</p>
        <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition-colors">
          Reload Page
        </button>
      </div>
    `;
    
    document.body.appendChild(errorDiv);
  }

  async viewPropertyDetails(propertyId) {
    window.location.href = `property-details.html?id=${propertyId}`;
  }

  async scheduleViewing(propertyId) {
    if (!this.currentUser) {
      this.showNotification('Please log in to schedule viewings', 'error');
      return;
    }

    // Check if user already has a viewing for this property
    try {
      const existingViewing = await db.collection('viewingRequests')
        .where('studentId', '==', this.currentUser.uid)
        .where('propertyId', '==', propertyId)
        .where('status', 'in', ['pending', 'scheduled'])
        .get();

      if (!existingViewing.empty) {
        this.showNotification('You already have a viewing request for this property', 'info');
        return;
      }

      // Create viewing request
      await db.collection('viewingRequests').add({
        studentId: this.currentUser.uid,
        propertyId: propertyId,
        status: 'pending',
        requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
        studentName: this.userProfile?.firstName || this.currentUser.displayName || 'Student',
        studentEmail: this.currentUser.email
      });

      this.showNotification('Viewing request submitted successfully! The landlord will contact you soon.', 'success');
      
      // Refresh dashboard stats
      await this.fetchDashboardStats(this.currentUser);

    } catch (error) {
      console.error('Error scheduling viewing:', error);
      this.showNotification('Failed to schedule viewing. Please try again.', 'error');
    }
  }

  async fetchReviews() {
    try {
      // Fetch recent reviews for display (optional)
      const reviewsSnapshot = await db.collection('reviews')
        .where('status', '==', 'approved')
        .orderBy('timestamp', 'desc')
        .limit(5)
        .get();

      const reviews = [];
      reviewsSnapshot.forEach(doc => {
        reviews.push({ id: doc.id, ...doc.data() });
      });

      console.log('Recent reviews:', reviews);
      // You could display these in a reviews section if needed

    } catch (error) {
      console.error('Failed to fetch reviews:', error);
    }
  }

  // Navigation methods for different sections
  async navigateToSection(section) {
    const sections = {
      'dashboard': 'student-dashboard.html',
      'properties': 'properties.html',
      'saved': 'saved-properties.html',
      'viewings': 'scheduled-viewings.html',
      'messages': 'messages.html',
      'profile': 'profile.html'
    };

    if (sections[section]) {
      window.location.href = sections[section];
    }
  }

  // Real-time listeners for dynamic updates
  setupRealTimeListeners() {
    if (!this.currentUser) return;

    // Listen for new messages
    this.messageListener = db.collection('messages')
      .where('recipientId', '==', this.currentUser.uid)
      .where('read', '==', false)
      .onSnapshot((snapshot) => {
        const unreadCount = snapshot.size;
        this.updateNotificationBadge(unreadCount);
        
        // Update messages card if visible
        const messagesCard = document.querySelector('[data-action="messages"] p');
        if (messagesCard) {
          messagesCard.textContent = unreadCount;
        }
      });

    // Listen for viewing updates
    this.viewingListener = db.collection('viewingRequests')
      .where('studentId', '==', this.currentUser.uid)
      .onSnapshot((snapshot) => {
        const scheduledViewings = snapshot.docs.filter(doc => 
          doc.data().status === 'scheduled'
        ).length;
        
        // Update viewings card if visible
        const viewingsCard = document.querySelector('[data-action="scheduled-viewings"] p');
        if (viewingsCard) {
          viewingsCard.textContent = scheduledViewings;
        }
      });
  }

  // Cleanup listeners when leaving page
  cleanup() {
    if (this.messageListener) this.messageListener();
    if (this.viewingListener) this.viewingListener();
  }
}

// Error handling wrapper
function initializeDashboard() {
  try {
    // Ensure Firebase is loaded
    if (typeof firebase === 'undefined' || !firebase.auth || !firebase.firestore) {
      throw new Error('Firebase not properly loaded');
    }

    // Initialize dashboard
    window.studentDashboard = new StudentDashboard();
    
    // Setup cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (window.studentDashboard) {
        window.studentDashboard.cleanup();
      }
    });

  } catch (error) {
    console.error('Critical error initializing dashboard:', error);
    
    // Show fallback error page
    document.body.innerHTML = `
      <div class="min-h-screen bg-gray-100 flex items-center justify-center">
        <div class="text-center p-8 bg-white rounded-lg shadow-lg max-w-md">
          <i class="fas fa-exclamation-triangle text-red-500 text-6xl mb-4"></i>
          <h1 class="text-2xl font-bold text-gray-800 mb-4">Dashboard Error</h1>
          <p class="text-gray-600 mb-4">Unable to load the dashboard. This might be due to:</p>
          <ul class="text-left text-sm text-gray-600 mb-6">
            <li>• Firebase configuration issues</li>
            <li>• Network connectivity problems</li>
            <li>• Browser compatibility issues</li>
          </ul>
          <div class="space-y-2">
            <button onclick="location.reload()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-colors">
              Reload Page
            </button>
            <button onclick="window.location.href='index.html'" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition-colors">
              Return to Home
            </button>
          </div>
        </div>
      </div>
    `;
  }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeDashboard);
} else {
  initializeDashboard();
}
    </script>
  </body>
</html>