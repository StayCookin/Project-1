<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#228B22" />
    <title>Property Marketplace - InRent</title>
    <!-- Preload critical assets -->
    <link
      rel="preload"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      as="style"
    />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap"
      as="style"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-1F24YHYS28"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-1F24YHYS28");
    </script>
   <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InRent Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
      :root {
        --forest-green: #228B22;
        --forest-green-dark: #176b16;
      }
      
      * {
        box-sizing: border-box;
      }
      
      body {
        margin: 0;
        padding: 0;
        background: #f8fafb;
        font-family: "Poppins", "Inter", Arial, sans-serif;
      }
      
      .marketplace-header {
        width: 100%;
        background: white;
        color: var(--forest-green);
        padding: 1rem;
        text-align: center;
        font-size: 1.8rem;
        font-weight: 700;
        letter-spacing: 1px;
        box-shadow: 0 2px 8px rgba(34, 139, 34, 0.08);
        margin-bottom: 1.5rem;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 60px;
      }
      
      .nav-buttons {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      
      .nav-btn {
        background: none;
        border: 1px solid var(--forest-green);
        border-radius: 5px;
        padding: 0.5rem 0.8rem;
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--forest-green);
        display: flex;
        align-items: center;
        gap: 0.3rem;
        transition: all 0.2s;
        white-space: nowrap;
      }
      
      .nav-btn:hover {
        background: #f0f8f0;
      }
      
      .logout-btn {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: white;
        border: 1.5px solid var(--forest-green);
        border-radius: 5px;
        padding: 0.5rem 0.8rem;
        font-weight: 600;
        transition: background 0.2s;
        cursor: pointer;
        color: var(--forest-green);
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }
      
      .logout-btn:hover {
        background: #f0f8f0;
      }
      
      .brand-text {
        font-size: 1.8rem;
        font-weight: 700;
      }
      
      .in {
        color: var(--forest-green);
      }
      
      .rent {
        color: var(--forest-green-dark);
      }
      
      .filter-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        justify-content: center;
        align-items: center;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        padding: 1rem;
        margin: 0 1rem 2rem 1rem;
        max-width: 1100px;
        margin-left: auto;
        margin-right: auto;
      }
      
      .filter-bar select,
      .filter-bar input[type="text"] {
        padding: 0.6rem 1rem;
        border: 1px solid var(--forest-green);
        border-radius: 5px;
        font-size: 1rem;
        min-width: 140px;
        flex: 1 1 140px;
      }
      
      .filter-bar button.btn {
        flex: 0 0 auto;
        white-space: nowrap;
        background: var(--forest-green);
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
      }
      
      .property-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        max-width: 1200px;
        margin: 0 auto 2rem auto;
        padding: 0 1rem;
      }
      
      .property-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: box-shadow 0.2s;
      }
      
      .property-card:hover {
        box-shadow: 0 8px 32px rgba(34, 139, 34, 0.13);
      }
      
      .property-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        background: #e6e6e6;
      }
      
      .property-info {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .property-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #222;
        margin-bottom: 0.2rem;
      }
      
      .property-location {
        color: var(--forest-green);
        font-size: 0.9rem;
        font-weight: 500;
      }
      
      .property-details {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        font-size: 0.9rem;
        color: #444;
        margin: 0.5rem 0;
      }
      
      .property-price {
        color: var(--forest-green-dark);
        font-size: 1.1rem;
        font-weight: 700;
        margin-top: 0.5rem;
      }
      
      .property-action {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: flex-end;
      }
      
      .property-action .btn {
        background: var(--forest-green);
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.9rem;
        flex: 1;
        min-width: 100px;
      }
      
      .property-action .btn:hover {
        background: var(--forest-green-dark);
      }
      
      .amenities-dropdown {
        position: relative;
        display: inline-block;
        min-width: 140px;
        flex: 1 1 140px;
      }
      
      .amenities-dropdown-btn {
        padding: 0.6rem 1rem;
        border: 1px solid var(--forest-green);
        border-radius: 5px;
        font-size: 1rem;
        background: #fff;
        color: #222;
        width: 100%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }
      
      .amenities-list {
        display: none;
        position: absolute;
        left: 0;
        top: 110%;
        z-index: 1000;
        background: #fff;
        border: 1px solid var(--forest-green);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 100%;
        padding: 0.5rem 0.7rem;
        max-height: 220px;
        overflow-y: auto;
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      
      .amenities-list.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
      }
      
      .amenities-list label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        padding: 0.3rem 0;
        cursor: pointer;
      }
      
      .amenities-list input[type="checkbox"] {
        accent-color: var(--forest-green);
      }
      
      /* Mobile Styles */
      @media (max-width: 768px) {
        .marketplace-header {
          font-size: 1.2rem;
          padding: 0.8rem;
          flex-direction: column;
          align-items: stretch;
          min-height: auto;
        }
        
        .nav-buttons {
          position: static;
          transform: none;
          justify-content: space-around;
          order: 2;
          margin-top: 0.5rem;
        }
        
        .nav-btn {
          font-size: 0.8rem;
          padding: 0.4rem 0.6rem;
          flex: 1;
          justify-content: center;
        }
        
        .logout-btn {
          position: static;
          transform: none;
          order: 3;
          margin-top: 0.5rem;
          align-self: center;
          font-size: 0.8rem;
          padding: 0.4rem 0.8rem;
        }
        
        .brand-text {
          font-size: 1.2rem;
          order: 1;
          text-align: center;
        }

        /* === MODIFIED STYLES START HERE === */
        .filter-bar {
          flex-wrap: wrap;
          justify-content: space-between;
          gap: 0.8rem;
          padding: 1rem;
          margin: 0 0.8rem 1.5rem 0.8rem;
        }

        .filter-bar select,
        .filter-bar .amenities-dropdown {
          flex: 1 1 calc(50% - 0.4rem);
          min-width: 130px;
        }

        .filter-bar input#searchInput,
        .filter-bar button.btn {
          flex-basis: 100%;
        }
        /* === MODIFIED STYLES END HERE === */
        
        .property-list {
          grid-template-columns: 1fr;
          gap: 1rem;
          padding: 0 0.5rem;
        }
        
        .property-action {
          flex-direction: column;
        }
        
        .property-action .btn {
          min-width: auto;
          flex: none;
        }
      }
      
      @media (max-width: 480px) {
        .nav-btn span {
          display: none;
        }
        
        .nav-btn {
          padding: 0.4rem;
          min-width: 40px;
          justify-content: center;
        }
        
        .logout-btn span {
          display: none;
        }
        
        .logout-btn {
          padding: 0.4rem;
          min-width: 40px;
          justify-content: center;
        }
        
        .brand-text {
          font-size: 1rem;
        }
      }
    </style>
</head>
<body>
    <div class="marketplace-header">
      <div class="nav-buttons">
        <button id="dashboardBtn" class="nav-btn" aria-label="Dashboard">
          <i class="fas fa-th-large"></i>
          <span>Dashboard</span>
        </button>
        <button id="messagesBtnHeader" class="nav-btn" aria-label="Messages">
          <i class="fas fa-comments"></i>
          <span>Messages</span>
        </button>
      </div>
      
      <div class="brand-text">
        <span class="in">In</span><span class="rent">Rent</span> Marketplace
      </div>
      
      <button id="logoutBtn" class="logout-btn" aria-label="Logout">
        <i class="fas fa-sign-out-alt"></i>
        <span>Log Out</span>
      </button>
    </div>
    
    <div class="filter-bar">
      <input
        type="text"
        id="searchInput"
        placeholder="Search location or title..."
      />
      <select id="typeFilter">
        <option value="">All Types</option>
        <option value="apartment">Apartment</option>
        <option value="house">House</option>
        <option value="studio">Studio</option>
        <option value="room">Room</option>
      </select>
      <select id="bedroomFilter">
        <option value="">Any Bedrooms</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3+</option>
      </select>
      <select id="priceFilter">
        <option value="">Any Price</option>
        <option value="0-2000">0-2,000</option>
        <option value="2001-4000">2,001-4,000</option>
        <option value="4001-6000">4,001-6,000</option>
        <option value="6000+">6,000+</option>
      </select>
        <select id="amenityFilter">
          <option value="">Amenities</option>
          <option value="wifi">Wifi</option>
          <option value="parking">Parking</option>
          <option value="furnished">Furnished</option>
          <option value="ac">Air Conditioning</option>
          <option value="security">Security</option>
        </select>
    </div>
      <button class="nav-btn" id="filterBtn" style="padding-right: 15px;">
        Filter
      </button>
    </div>
    <div class="property-list" id="propertyList">
      </div>


    <footer
      style="
        background: #fff;
        border-top: 1px solid #e6e6e6;
        padding: 1.5rem 1rem;
        text-align: center;
        font-size: 1rem;
        color: var(--forest-green);
        margin-top: 2rem;
      "
    >
      &copy; 2025 InRent. All rights reserved. &middot;
      <a
        href="frontend/privacy.html"
        style="color: var(--forest-green-dark); text-decoration: underline"
        >Privacy Policy</a
      >
      &middot;
      <a href="/terms.html" style="color: var(--forest-green-dark); text-decoration: underline"
        >Terms</a
      >
    </footer>
  </body>
  <script type="module" defer>
    // Imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut,
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  collection,
  query,
  where,
  getDocs,
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAXKk5gRjwSGK_g9f_HP_f4y4445e_8l4w",
  authDomain: "project-1-1e31c.firebaseapp.com",
  projectId: "project-1-1e31c",
  storageBucket: "project-1-1e31c.firebasestorage.app",
  messagingSenderId: "658275930203",
  appId: "1:658275930203:web:afc2e2a249509737b0ef7e",
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Global variables - data from Firebase only
let currentUser = null;
let currentUserData = null;
let currentProperties = [];
let filteredProperties = [];

// Real-time listener for property updates
async function setupPropertiesListener(role, user) {
  console.log(`üëÇ Setting up real-time properties listener for ${role}`);
  
  try {
    const { onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js");
    const propertiesRef = collection(db, "properties");
    
    let propertiesQuery;
    if (role === "LANDLORD") {
      propertiesQuery = query(propertiesRef, where("landlordId", "==", user.uid));
    } else if (role === "STUDENT") {
      propertiesQuery = query(propertiesRef, where("status", "==", "available"));
    }
    
    // Set up real-time listener
    const unsubscribe = onSnapshot(propertiesQuery, (snapshot) => {
      console.log("üîÑ Properties updated in real-time");
      currentProperties = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      
      // Reapply current filters to updated data
      applyCurrentFilters();
    }, (error) => {
      console.error("‚ùå Properties listener error:", error);
    });
    
    // Store unsubscribe function for cleanup
    window.propertiesUnsubscribe = unsubscribe;
    
  } catch (error) {
    console.error("‚ùå Failed to setup properties listener:", error);
    // Fallback to one-time load
    await loadProperties(role, user);
  }
}

// Navigation setup
function setupNavigationButtons(role) {
  console.log(`üß≠ Setting up navigation for ${role}`);
  
  // Add Property button (landlords only)
  const addPropertyBtn = document.getElementById('addPropertyBtn');
  if (addPropertyBtn) {
    addPropertyBtn.addEventListener('click', () => {
      window.location.href = 'add-property.html';
    });
  }
  
  // Profile button
  const profileBtn = document.getElementById('profileBtn');
  if (profileBtn) {
    profileBtn.addEventListener('click', () => {
      window.location.href = 'profile.html';
    });
  }
  
  // Settings button
  const settingsBtn = document.getElementById('settingsBtn');
  if (settingsBtn) {
    settingsBtn.addEventListener('click', () => {
      window.location.href = 'settings.html';
    });
  }
  
  // Help/Support button
  const helpBtn = document.getElementById('helpBtn');
  if (helpBtn) {
    helpBtn.addEventListener('click', () => {
      window.location.href = 'help.html';
    });
  }
}

// Logout functionality
function setupLogout() {
  console.log("üö™ Setting up logout functionality");
  
  // Additional logout buttons if any
  const logoutBtns = document.querySelectorAll('[data-action="logout"]');
  logoutBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      try {
        // Clean up listeners
        if (window.propertiesUnsubscribe) {
          window.propertiesUnsubscribe();
        }
        
        await signOut(auth);
        window.location.href = "index.html";
      } catch (error) {
        console.error("‚ùå Logout error:", error);
        alert("Error logging out. Please try again.");
      }
    });
  });
}

// UI adjustments based on role
function adjustUIForRole(role) {
  console.log(`üé® Adjusting UI elements for ${role}`);
  
  // Role-specific styling
  const body = document.body;
  body.className = body.className.replace(/role-\w+/g, '');
  body.classList.add(`role-${role.toLowerCase()}`);
  
  // Adjust search placeholder text
  const searchInput = document.getElementById("searchInput");
  if (searchInput) {
    searchInput.placeholder = role === 'STUDENT' 
      ? "Search properties, locations, amenities..." 
      : "Search your properties...";
  }
  
  // Show/hide filters based on role
  const studentFilters = document.querySelectorAll('.filter-student-only');
  const landlordFilters = document.querySelectorAll('.filter-landlord-only');
  
  studentFilters.forEach(filter => {
    filter.style.display = role === 'STUDENT' ? 'block' : 'none';
  });
  
  landlordFilters.forEach(filter => {
    filter.style.display = role === 'LANDLORD' ? 'block' : 'none';
  });
  
  // Update page header with user info
  const userInfo = document.getElementById('userInfo');
  if (userInfo && currentUserData) {
    userInfo.innerHTML = `
      <span class="user-email">${currentUserData.email}</span>
      <span class="user-role">${role === 'STUDENT' ? 'Student' : 'Landlord'}</span>
    `;
  }
}

// DOM element references
const dashboard = document.getElementById("dashboardBtn");
const messages = document.getElementById("messagesBtnHeader");
const logOut = document.getElementById("logoutBtn");

// Logout function
if (logOut) {
  logOut.addEventListener("click", async () => {
    try {
      console.log("üö™ Logging out user...");
      await signOut(auth);
      console.log("‚úÖ Logout successful, redirecting to login");
      window.location.href = "index.html";
    } catch (error) {
      console.error("‚ùå Logout error:", error);
      alert("Error logging out. Please try again.");
    }
  });
}

// Redirect to messages page
if (messages) {
  messages.addEventListener("click", () => {
    console.log("üì® Redirecting to messages page");
    window.location.href = "messages.html";
  });
}

// Dashboard redirect based on role from Firebase
if (dashboard) {
  dashboard.addEventListener("click", () => {
    if (!currentUserData || !currentUserData.role) {
      console.log("‚ùå No user data available, requesting login");
      alert("Please login to access your dashboard.");
      signOut(auth).then(() => {
        window.location.href = "index.html";
      });
      return;
    }
    
    const role = currentUserData.role;
    console.log("üè† Dashboard clicked. Current role:", role);
    
    if (role === "LANDLORD") {
      console.log("üè† Redirecting to landlord dashboard");
      window.location.href = "landlord-dashboard.html";
    } else if (role === "STUDENT") {
      console.log("üéì Redirecting to student dashboard");
      window.location.href = "student-dashboard.html";
    } else {
      console.log("‚ùå Invalid role found:", role);
      alert("Invalid user role. Please contact support.");
      signOut(auth).then(() => {
        window.location.href = "index.html";
      });
    }
  });
}

// Search and Filter Functionality
function setupSearchAndFilters(role) {
  console.log(`üîç Setting up search and filters for ${role}`);
  
  // Search functionality
  const searchInput = document.getElementById("searchInput");
  const searchBtn = document.getElementById("searchBtn");
  const sortBy = document.getElementById("sortBy");
  
  if (searchBtn) {
    searchBtn.addEventListener("click", () => {
      performAdvancedSearch();
    });
  }
  
  if (searchInput) {
    searchInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        performAdvancedSearch();
      }
    });
    
    // Real-time search as user types (with debouncing)
    searchInput.addEventListener("input", () => {
      clearTimeout(searchInput.searchTimeout);
      searchInput.searchTimeout = setTimeout(performAdvancedSearch, 300);
    });
  }
  
  // Sort functionality
  if (sortBy) {
    sortBy.addEventListener("change", () => {
      performAdvancedSearch();
    });
  }
  
  // Filter functionality
  const filterBtn = document.getElementById("filterBtn");
  const applyFiltersBtn = document.getElementById("applyFiltersBtn");
  const clearFiltersBtn = document.getElementById("clearFiltersBtn");
  
  if (filterBtn) {
    filterBtn.addEventListener("click", () => {
      toggleFilterPanel();
    });
  }
  
  if (applyFiltersBtn) {
    applyFiltersBtn.addEventListener("click", () => {
      applyCurrentFilters();
    });
  }
  
  if (clearFiltersBtn) {
    clearFiltersBtn.addEventListener("click", () => {
      clearAllFilters();
    });
  }
  
  // Price range filters with validation
  const minPriceInput = document.getElementById("minPrice");
  const maxPriceInput = document.getElementById("maxPrice");
  
  if (minPriceInput) {
    minPriceInput.addEventListener("change", () => {
      validatePriceRange();
      applyCurrentFilters();
    });
  }
  
  if (maxPriceInput) {
    maxPriceInput.addEventListener("change", () => {
      validatePriceRange();
      applyCurrentFilters();
    });
  }
  
  // Location filter
  const locationSelect = document.getElementById("locationFilter");
  if (locationSelect) {
    locationSelect.addEventListener("change", applyCurrentFilters);
  }
  
  // Property type filter
  const propertyTypeSelect = document.getElementById("propertyTypeFilter");
  if (propertyTypeSelect) {
    propertyTypeSelect.addEventListener("change", applyCurrentFilters);
  }
  
  // Availability filter (for landlords)
  const availabilityFilter = document.getElementById("availabilityFilter");
  if (availabilityFilter && role === "LANDLORD") {
    availabilityFilter.addEventListener("change", applyCurrentFilters);
  }
  
  // Setup quick filters
  setupQuickFilters();
}

/**
 * Validates price range inputs
 */
function validatePriceRange() {
  const minPrice = document.getElementById("minPrice");
  const maxPrice = document.getElementById("maxPrice");
  
  if (minPrice && maxPrice) {
    const min = parseFloat(minPrice.value) || 0;
    const max = parseFloat(maxPrice.value) || Infinity;
    
    if (min > max && max !== Infinity) {
      maxPrice.setCustomValidity("Maximum price must be greater than minimum price");
      maxPrice.reportValidity();
    } else {
      maxPrice.setCustomValidity("");
    }
  }
}

/**
 * Performs search with current sort order (replaces simple performSearch)
 */
function performSearch() {
  performAdvancedSearch();
}

/**
 * Advanced search with sorting options
 */
function performAdvancedSearch() {
  const searchInput = document.getElementById("searchInput");
  const sortBy = document.getElementById("sortBy")?.value || "newest";
  const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : "";
  
  console.log("üîç Performing advanced search:", { searchTerm, sortBy });
  
  let filtered = [...currentProperties];
  
  // Apply search filter
  if (searchTerm) {
    filtered = filtered.filter(property => {
      const searchableFields = [
        property.title,
        property.description,
        property.location,
        property.address,
        property.neighborhood,
        property.propertyType,
        property.landlordName
      ].filter(Boolean).map(field => field.toLowerCase());
      
      const amenitiesText = (property.amenities || []).join(' ').toLowerCase();
      searchableFields.push(amenitiesText);
      
      return searchableFields.some(field => field.includes(searchTerm));
    });
  }
  
  // Apply sorting
  filtered.sort((a, b) => {
    switch (sortBy) {
      case 'price-low':
        return (parseFloat(a.rent) || 0) - (parseFloat(b.rent) || 0);
      case 'price-high':
        return (parseFloat(b.rent) || 0) - (parseFloat(a.rent) || 0);
      case 'location':
        return (a.location || '').localeCompare(b.location || '');
      case 'newest':
      default:
        const dateA = a.createdAt?.seconds || 0;
        const dateB = b.createdAt?.seconds || 0;
        return dateB - dateA;
    }
  });
  
  filteredProperties = filtered;
  displayProperties(filteredProperties);
  updateResultsCount();
}

/**
 * Quick filters for common searches
 */
function applyQuickFilter(filterType) {
  console.log("‚ö° Applying quick filter:", filterType);
  
  let filtered = [...currentProperties];
  
  switch (filterType) {
    case 'under-500':
      filtered = filtered.filter(p => parseFloat(p.rent) <= 500);
      break;
    case 'under-1000':
      filtered = filtered.filter(p => parseFloat(p.rent) <= 1000);
      break;
    case 'furnished':
      filtered = filtered.filter(p => 
        p.amenities?.some(amenity => 
          amenity.toLowerCase().includes('furnished')
        )
      );
      break;
    case 'pet-friendly':
      filtered = filtered.filter(p => 
        p.amenities?.some(amenity => 
          amenity.toLowerCase().includes('pet') || 
          amenity.toLowerCase().includes('animal')
        )
      );
      break;
    case 'wifi':
      filtered = filtered.filter(p => 
        p.amenities?.some(amenity => 
          amenity.toLowerCase().includes('wifi') || 
          amenity.toLowerCase().includes('internet')
        )
      );
      break;
    case 'parking':
      filtered = filtered.filter(p => 
        p.amenities?.some(amenity => 
          amenity.toLowerCase().includes('parking') || 
          amenity.toLowerCase().includes('garage')
        )
      );
      break;
    default:
      console.warn("Unknown quick filter:", filterType);
      return;
  }
  
  filteredProperties = filtered;
  displayProperties(filteredProperties);
  updateResultsCount();
  
  // Update UI to show active filter
  document.querySelectorAll('.quick-filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector(`[data-filter="${filterType}"]`)?.classList.add('active');
}

/**
 * Setup quick filter buttons
 */
function setupQuickFilters() {
  const quickFilterBtns = document.querySelectorAll('.quick-filter-btn');
  quickFilterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const filterType = btn.dataset.filter;
      if (filterType) {
        applyQuickFilter(filterType);
      }
    });
  });
  
  // Clear quick filters button
  const clearQuickFiltersBtn = document.getElementById('clearQuickFilters');
  if (clearQuickFiltersBtn) {
    clearQuickFiltersBtn.addEventListener('click', () => {
      document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      filteredProperties = [...currentProperties];
      displayProperties(filteredProperties);
      updateResultsCount();
    });
  }
}

/**
 * Toggles filter panel visibility
 */
function toggleFilterPanel() {
  const filterPanel = document.getElementById("filterPanel");
  const filterBtn = document.getElementById("filterBtn");
  
  if (filterPanel) {
    const isVisible = filterPanel.classList.toggle("show");
    console.log("üéõÔ∏è Filter panel toggled:", isVisible ? "visible" : "hidden");
    
    if (filterBtn) {
      filterBtn.textContent = isVisible ? "Hide Filters" : "Show Filters";
    }
  }
}

/**
 * Applies current filters to properties
 */
function applyCurrentFilters() {
  console.log("üéõÔ∏è Applying current filters...");
  
  let filtered = [...currentProperties];
  
  // Apply search term first
  const searchInput = document.getElementById("searchInput");
  const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : "";
  
  if (searchTerm) {
    filtered = filtered.filter(property => {
      const searchableFields = [
        property.title,
        property.description,
        property.location,
        property.address,
        property.neighborhood,
        property.propertyType
      ].filter(Boolean).map(field => field.toLowerCase());
      
      const amenitiesText = (property.amenities || []).join(' ').toLowerCase();
      searchableFields.push(amenitiesText);
      
      return searchableFields.some(field => field.includes(searchTerm));
    });
  }
  
  // Price range filter
  const minPrice = parseFloat(document.getElementById("minPrice")?.value) || 0;
  const maxPrice = parseFloat(document.getElementById("maxPrice")?.value) || Infinity;
  
  if (minPrice > 0 || maxPrice < Infinity) {
    filtered = filtered.filter(property => {
      const price = parseFloat(property.rent) || 0;
      return price >= minPrice && price <= maxPrice;
    });
  }
  
  // Location filter
  const locationFilter = document.getElementById("locationFilter")?.value;
  if (locationFilter && locationFilter !== "all") {
    filtered = filtered.filter(property => 
      property.location?.toLowerCase().includes(locationFilter.toLowerCase()) ||
      property.neighborhood?.toLowerCase().includes(locationFilter.toLowerCase())
    );
  }
  
  // Property type filter
  const propertyTypeFilter = document.getElementById("propertyTypeFilter")?.value;
  if (propertyTypeFilter && propertyTypeFilter !== "all") {
    filtered = filtered.filter(property => 
      property.propertyType?.toLowerCase() === propertyTypeFilter.toLowerCase()
    );
  }
  
  // Availability filter (mainly for landlords)
  const availabilityFilter = document.getElementById("availabilityFilter")?.value;
  if (availabilityFilter && availabilityFilter !== "all") {
    filtered = filtered.filter(property => 
      property.status?.toLowerCase() === availabilityFilter.toLowerCase()
    );
  }
  
  // Amenities filter
  const selectedAmenities = Array.from(
    document.querySelectorAll('#amenitiesList input[type="checkbox"]:checked')
  ).map(checkbox => checkbox.value);
  
  if (selectedAmenities.length > 0) {
    filtered = filtered.filter(property => {
      const propertyAmenities = (property.amenities || []).map(a => a.toLowerCase());
      return selectedAmenities.every(amenity => 
        propertyAmenities.some(propAmenity => 
          propAmenity.includes(amenity.toLowerCase())
        )
      );
    });
  }
  
  filteredProperties = filtered;
  console.log(`üéõÔ∏è Filters applied: ${filteredProperties.length} properties match criteria`);
  displayProperties(filteredProperties);
  updateResultsCount();
}

/**
 * Clears all filters and search
 */
function clearAllFilters() {
  console.log("üßπ Clearing all filters");
  
  // Clear search input
  const searchInput = document.getElementById("searchInput");
  if (searchInput) searchInput.value = "";
  
  // Clear price filters
  const minPrice = document.getElementById("minPrice");
  const maxPrice = document.getElementById("maxPrice");
  if (minPrice) minPrice.value = "";
  if (maxPrice) maxPrice.value = "";
  
  // Reset select filters
  const locationFilter = document.getElementById("locationFilter");
  const propertyTypeFilter = document.getElementById("propertyTypeFilter");
  const availabilityFilter = document.getElementById("availabilityFilter");
  
  if (locationFilter) locationFilter.value = "all";
  if (propertyTypeFilter) propertyTypeFilter.value = "all";
  if (availabilityFilter) availabilityFilter.value = "all";
  
  // Clear amenities checkboxes
  const amenityCheckboxes = document.querySelectorAll('#amenitiesList input[type="checkbox"]');
  amenityCheckboxes.forEach(checkbox => checkbox.checked = false);
  updateAmenitiesCount();
  
  // Show all properties
  filteredProperties = [...currentProperties];
  displayProperties(filteredProperties);
  updateResultsCount();
}

/**
 * Updates results count display
 */
function updateResultsCount() {
  const resultsCount = document.getElementById("resultsCount");
  if (resultsCount) {
    resultsCount.textContent = `${filteredProperties.length} properties found`;
  }
}

/**
 * Load properties based on user role from Firebase (initial load)
 */
async function loadProperties(role, user) {
  try {
    console.log(`üè† Loading properties for ${role}`);
    const propertiesRef = collection(db, "properties");
    
    let propertiesQuery;
    if (role === "LANDLORD") {
      // Landlords see only their own properties (all statuses)
      propertiesQuery = query(propertiesRef, where("landlordId", "==", user.uid));
    } else if (role === "STUDENT") {
      // Students see all available properties
      propertiesQuery = query(propertiesRef, where("status", "==", "available"));
    } else {
      console.error("‚ùå Invalid role for loading properties:", role);
      return;
    }
    
    const snapshot = await getDocs(propertiesQuery);
    currentProperties = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    // Sort properties by creation date (newest first)
    currentProperties.sort((a, b) => {
      const dateA = a.createdAt?.seconds || 0;
      const dateB = b.createdAt?.seconds || 0;
      return dateB - dateA;
    });
    
    filteredProperties = [...currentProperties];
    console.log(`‚úÖ Loaded ${currentProperties.length} properties`);
    
    displayProperties(filteredProperties);
    updateResultsCount();
    populateFilterOptions();
    
  } catch (error) {
    console.error("‚ùå Error loading properties:", error);
    showErrorState(error);
  }
}

/**
 * Populates filter dropdown options based on available properties
 */
function populateFilterOptions() {
  try {
    // Populate location filter
    const locationFilter = document.getElementById("locationFilter");
    if (locationFilter && currentProperties.length > 0) {
      const locations = [...new Set(currentProperties
        .map(p => p.location)
        .filter(Boolean)
      )].sort();
      
      // Keep existing options and add new ones
      const existingOptions = Array.from(locationFilter.options).map(opt => opt.value);
      locations.forEach(location => {
        if (!existingOptions.includes(location)) {
          const option = document.createElement('option');
          option.value = location;
          option.textContent = location;
          locationFilter.appendChild(option);
        }
      });
    }
    
    // Populate property type filter
    const propertyTypeFilter = document.getElementById("propertyTypeFilter");
    if (propertyTypeFilter && currentProperties.length > 0) {
      const propertyTypes = [...new Set(currentProperties
        .map(p => p.propertyType)
        .filter(Boolean)
      )].sort();
      
      const existingOptions = Array.from(propertyTypeFilter.options).map(opt => opt.value);
      propertyTypes.forEach(type => {
        if (!existingOptions.includes(type)) {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type;
          propertyTypeFilter.appendChild(option);
        }
      });
    }
    
    console.log("‚úÖ Filter options populated");
  } catch (error) {
    console.error("‚ùå Error populating filter options:", error);
  }
}

/**
 * Shows error state in property list
 */
function showErrorState(error) {
  const propertyList = document.getElementById("propertyList");
  if (propertyList) {
    let errorMessage = "Unable to load properties. Please try again.";
    
    if (error.code === 'permission-denied') {
      errorMessage = "Permission denied. Please check your account permissions.";
    } else if (error.code === 'unavailable') {
      errorMessage = "Database temporarily unavailable. Please try again in a few moments.";
    } else if (error.message?.includes('timeout')) {
      errorMessage = "Connection timed out. Please check your internet connection.";
    }
    
    propertyList.innerHTML = `
      <div class="error-state" style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #d32f2f;">
        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
        <h3>Error Loading Properties</h3>
        <p>${errorMessage}</p>
        <div style="margin-top: 1rem;">
          <button onclick="location.reload()" style="margin-right: 0.5rem; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Retry
          </button>
          <button onclick="signOut(auth).then(() => window.location.href='index.html')" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Logout
          </button>
        </div>
      </div>`;
  }
}

/**
 * Displays properties in the UI
 */
function displayProperties(properties) {
  const propertyList = document.getElementById("propertyList");
  if (!propertyList) {
    console.warn("‚ö†Ô∏è Property list container not found");
    return;
  }
  
  if (properties.length === 0) {
    propertyList.innerHTML = `
      <div class="no-results" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
        <i class="fas fa-search" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
        <h3>No properties found</h3>
        <p>Try adjusting your search criteria or filters.</p>
        <button onclick="clearAllFilters()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Clear Filters
        </button>
      </div>`;
    return;
  }
  
  propertyList.innerHTML = properties.map(property => `
    <div class="property-card" data-property-id="${property.id}">
      <div class="property-image">
        <img src="${property.imageUrl || property.images?.[0] || '/placeholder-property.jpg'}" 
             alt="${property.title}" 
             onerror="this.src='/placeholder-property.jpg'">
        ${property.status === 'rented' ? '<div class="status-badge rented">Rented</div>' : ''}
        ${property.featured ? '<div class="status-badge featured">Featured</div>' : ''}
      </div>
      <div class="property-details">
        <h3>${property.title}</h3>
        <p class="location">üìç ${property.location}${property.neighborhood ? `, ${property.neighborhood}` : ''}</p>
        <p class="price">üí∞ P${property.rent}/month</p>
        ${property.propertyType ? `<p class="property-type">üè† ${property.propertyType}</p>` : ''}
        <div class="amenities">
          ${(property.amenities || []).slice(0, 3).map(amenity => 
            `<span class="amenity-tag">${amenity}</span>`
          ).join('')}
          ${property.amenities?.length > 3 ? `<span class="amenity-more">+${property.amenities.length - 3} more</span>` : ''}
        </div>
        <div class="property-actions">
          <button class="view-details-btn" onclick="viewPropertyDetails('${property.id}')">
            View Details
          </button>
          ${currentUserData?.role === 'LANDLORD' && property.landlordId === currentUser?.uid ? 
            `<button class="edit-property-btn" onclick="editProperty('${property.id}')">Edit</button>` : 
            ''
          }
          ${currentUserData?.role === 'STUDENT' && property.status === 'available' ? 
            `<button class="contact-landlord-btn" onclick="contactLandlord('${property.id}')">Contact</button>` : 
            ''
          }
        </div>
      </div>
    </div>
  `).join('');
}

/**
 * View property details
 */
function viewPropertyDetails(propertyId) {
  console.log("üëÅÔ∏è Viewing details for property:", propertyId);
  window.location.href = `property-details.html?id=${propertyId}`;
}

/**
 * Edit property (for landlords)
 */
function editProperty(propertyId) {
  console.log("‚úèÔ∏è Editing property:", propertyId);
  window.location.href = `edit-property.html?id=${propertyId}`;
}

/**
 * Contact landlord (for students)
 */
function contactLandlord(propertyId) {
  console.log("üìû Contacting landlord for property:", propertyId);
  window.location.href = `messages.html?property=${propertyId}`;
}

// Main authentication and initialization
document.addEventListener("DOMContentLoaded", () => {
  console.log("üöÄ DOM loaded, initializing marketplace...");
  showLoadingState();

  onAuthStateChanged(auth, async (user) => {
    console.log("üîç Auth state changed. User:", user);
    
    if (!user) {
      console.log("‚ùå No authenticated user found, redirecting to login");
      window.location.href = "index.html";
      return;
    }

    currentUser = user;
    console.log("‚úÖ User authenticated:");
    console.log("  - UID:", user.uid);
    console.log("  - Email:", user.email);
    console.log("  - Email Verified:", user.emailVerified);

    // Check email verification
    if (!user.emailVerified) {
      console.log("‚ùå User email not verified");
      alert("Please verify your email address before accessing the marketplace. Check your email for a verification link.");
      await signOut(auth);
      window.location.href = "signup.html";
      return;
    }

    try {
      // Get user data from Firestore
      console.log(`üîç Fetching user data from Firestore for UID: ${user.uid}`);
      const userDocRef = doc(db, "users", user.uid);
      const userDoc = await getDoc(userDocRef);

      if (!userDoc.exists()) {
        console.error("‚ùå User document not found in Firestore!");
        alert("Your user profile was not found. Please sign up again or contact support.");
        await signOut(auth);
        window.location.href = "signup.html";
        return;
      }

      const userData = userDoc.data();
      console.log("‚úÖ User data retrieved from Firestore:", userData);
      
      // Validate required fields
      const requiredFields = ['email', 'role'];
      const missingFields = requiredFields.filter(field => !userData.hasOwnProperty(field));
      
      if (missingFields.length > 0) {
        console.error("‚ùå Missing required fields:", missingFields);
        alert(`Your profile is incomplete. Missing: ${missingFields.join(', ')}. Please contact support.`);
        return;
      }

      // Validate role
      const role = userData.role?.toString().trim();
      const validRoles = ['STUDENT', 'LANDLORD'];
      
      if (!validRoles.includes(role)) {
        console.error(`‚ùå Invalid role: '${role}'`);
        alert(`Invalid user role: '${role}'. Please contact support.`);
        await signOut(auth);
        window.location.href = "signup.html";
        return;
      }

      // Store user data globally (from Firebase, not localStorage)
      currentUserData = userData;
      
      console.log(`‚úÖ User authenticated successfully. Role: ${role}`);
      
      hideLoadingState();
      updateUIForRole(role, user);
      setupEventListeners(role, user);
      
      // Load properties based on role
      await loadProperties(role, user);

    } catch (error) {
      console.error("üí• Error in authentication flow:", error);
      
      // Specific error handling
      if (error.code === 'permission-denied') {
        alert("Permission denied. Your account may not have the required permissions. Please contact support.");
      } else if (error.code === 'unavailable') {
        alert("Database temporarily unavailable. Please try again in a few moments.");
      } else if (error.message?.includes('timeout')) {
        alert("Database connection timed out. Please check your internet connection and try again.");
      } else {
        alert(`Error loading profile: ${error.message}. Please try refreshing the page.`);
      }
      
      hideLoadingState();
      await signOut(auth);
      window.location.href = "index.html";
    }
  });
});

/**
 * Updates UI elements based on user role
 */
function updateUIForRole(role, user) {
  console.log(`üé® Updating UI for role: ${role}`);
  
  const welcomeMessage = document.getElementById('welcomeMessage');
  if (welcomeMessage) {
    welcomeMessage.textContent = role === 'STUDENT'
      ? 'Find Your Perfect Student Accommodation'
      : role === 'LANDLORD'
      ? 'Manage Your Properties'
      : 'Dashboard';
  }

  const pageTitle = document.querySelector('h1');
  if (pageTitle) {
    pageTitle.textContent = role === 'STUDENT'
      ? 'Browse Properties'
      : role === 'LANDLORD'
      ? 'Property Management'
      : 'Dashboard';
  }

  const headerRole = document.getElementById('userRoleIndicator');
  if (headerRole) {
    const displayRole = role === 'STUDENT' ? 'Student' : role === 'LANDLORD' ? 'Landlord' : role;
    headerRole.textContent = `${displayRole} Dashboard`;
  }

  // Show/hide role-specific elements
  const addPropertyBtn = document.getElementById('addPropertyBtn');
  if (addPropertyBtn) {
    addPropertyBtn.style.display = role === 'LANDLORD' ? 'inline-block' : 'none';
  }
  
  const studentOnlyElements = document.querySelectorAll('.student-only');
  const landlordOnlyElements = document.querySelectorAll('.landlord-only');
  
  studentOnlyElements.forEach(el => {
    el.style.display = role === 'STUDENT' ? 'block' : 'none';
  });
  
  landlordOnlyElements.forEach(el => {
    el.style.display = role === 'LANDLORD' ? 'block' : 'none';
  });

  adjustUIForRole(role);
}

/**
 * Sets up event listeners after successful authentication
 */
function setupEventListeners(role, user) {
  console.log(`‚öôÔ∏è Setting up event listeners for ${role}`);
  
  setupAmenitiesDropdown();
  setupNavigationButtons(role);
  setupLogout();
  setupPropertiesListener(role, user);
  setupSearchAndFilters(role);
}

/**
 * Amenities dropdown functionality
 */
function setupAmenitiesDropdown() {
  const dropdownBtn = document.getElementById('amenitiesDropdownBtn');
  const dropdownList = document.getElementById('amenitiesList');

  if (!dropdownBtn || !dropdownList) {
    console.warn("‚ö†Ô∏è Amenities dropdown elements not found");
    return;
  }
  
  if (dropdownBtn.dataset.initialized) return;
  dropdownBtn.dataset.initialized = 'true';

  dropdownBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    const isExpanded = dropdownList.classList.toggle('show');
    dropdownBtn.setAttribute('aria-expanded', isExpanded);
  });

  document.addEventListener('click', (e) => {
    if (!dropdownBtn.contains(e.target) && !dropdownList.contains(e.target)) {
      if (dropdownList.classList.contains('show')) {
        dropdownList.classList.remove('show');
        dropdownBtn.setAttribute('aria-expanded', 'false');
      }
    }
  });

  dropdownList.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  const checkboxes = dropdownList.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      updateAmenitiesCount();
      setTimeout(applyCurrentFilters, 100);
    });
  });
}

/**
 * Updates amenities counter
 */
function updateAmenitiesCount() {
  const checkboxes = document.querySelectorAll('#amenitiesList input[type="checkbox"]:checked');
  const countSpan = document.getElementById('amenitiesSelectedCount');
  if (countSpan) {
    countSpan.textContent = checkboxes.length > 0 ? `(${checkboxes.length})` : '';
  }
}

/**
 * Shows loading state
 */
function showLoadingState() {
  const propertyList = document.getElementById("propertyList");
  if (propertyList) {
    propertyList.innerHTML = `
      <div class="loading-state" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--forest-green);"></i>
        <p>Loading marketplace...</p>
      </div>`;
  }
}

/**
 * Hides loading state
 */
function hideLoadingState() {
  const propertyList = document.getElementById("propertyList");
  if (propertyList) {
    const loadingState = propertyList.querySelector('.loading-state');
    if (loadingState) {
      loadingState.remove();
    }
  }
}

// Make functions globally available for HTML onclick handlers
window.viewPropertyDetails = viewPropertyDetails;
window.editProperty = editProperty;
window.contactLandlord = contactLandlord;
window.applyCurrentFilters = applyCurrentFilters;
window.clearAllFilters = clearAllFilters;
window.performSearch = performSearch;
window.performAdvancedSearch = performAdvancedSearch;
window.applyQuickFilter = applyQuickFilter;
window.signOut = signOut;
window.auth = auth;

// Cleanup function for page unload
window.addEventListener('beforeunload', () => {
  if (window.propertiesUnsubscribe) {
    window.propertiesUnsubscribe();
  }
});

// Export key functions for other modules if needed
export {
  auth,
  db,
  currentUser,
  currentUserData,
  currentProperties,
  filteredProperties,
  loadProperties,
  applyCurrentFilters,
  performAdvancedSearch
};
    </script>
</html>